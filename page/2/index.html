<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Crzidea</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Crzidea">
<meta property="og:url" content="https://crzidea.com/page/2/index.html">
<meta property="og:site_name" content="Crzidea">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Crzidea">
  
    <link rel="alternative" href="/atom.xml" title="Crzidea" type="application/atom+xml">
  
  
  <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
</head>

<body>

  <!-- 分享时显示的图片 -->
  <div style='display:none;'>
      <img src="/favicon.png" />
  </div>

  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/avatar.png" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">crzidea.com</a></h1>
		</hgroup>

		
		


		
			<div id="switch-btn" class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>

				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
					</ul>
				</div>
			</div>
		

		<div id="switch-area" class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives/">列表</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<ul class="social">
							
								<li id="Email"><a class="Email" target="_blank" href="mailto:micro-tech@foxmail.com" title="Email"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/crzidea" title="GitHub"></a></li>
					        
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/crzidea" title="新浪微博"></a></li>
					        
								<li id="QQ"><a class="QQ" target="_blank" href="http://wpa.qq.com/msgrd?v=3&uin=133683737&site=qq&menu=yes" title="QQ"></a></li>
					        
						</ul>
					</nav>
				</section>

				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Bash/" style="font-size: 10px;">Bash</a> <a href="/tags/FEDAY/" style="font-size: 10px;">FEDAY</a> <a href="/tags/RESTful/" style="font-size: 10px;">RESTful</a> <a href="/tags/React/" style="font-size: 10px;">React</a> <a href="/tags/WSL/" style="font-size: 10px;">WSL</a> <a href="/tags/Windows/" style="font-size: 10px;">Windows</a> <a href="/tags/array/" style="font-size: 10px;">array</a> <a href="/tags/build/" style="font-size: 10px;">build</a> <a href="/tags/database/" style="font-size: 10px;">database</a> <a href="/tags/date/" style="font-size: 10px;">date</a> <a href="/tags/deploy/" style="font-size: 10px;">deploy</a> <a href="/tags/distribution/" style="font-size: 10px;">distribution</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-registry-mirror/" style="font-size: 10px;">docker registry mirror</a> <a href="/tags/full-stack/" style="font-size: 10px;">full stack</a> <a href="/tags/gamepad/" style="font-size: 10px;">gamepad</a> <a href="/tags/gopigo/" style="font-size: 10px;">gopigo</a> <a href="/tags/https/" style="font-size: 10px;">https</a> <a href="/tags/javascript/" style="font-size: 20px;">javascript</a> <a href="/tags/koa/" style="font-size: 10px;">koa</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/memory-leak/" style="font-size: 10px;">memory leak</a> <a href="/tags/micro-service/" style="font-size: 10px;">micro service</a> <a href="/tags/mintty/" style="font-size: 10px;">mintty</a> <a href="/tags/nodejs/" style="font-size: 20px;">nodejs</a> <a href="/tags/ops/" style="font-size: 10px;">ops</a> <a href="/tags/performace/" style="font-size: 10px;">performace</a> <a href="/tags/range/" style="font-size: 10px;">range</a> <a href="/tags/raspberry-pi/" style="font-size: 10px;">raspberry pi</a> <a href="/tags/replace/" style="font-size: 10px;">replace</a> <a href="/tags/replication/" style="font-size: 10px;">replication</a> <a href="/tags/rethinkdb/" style="font-size: 10px;">rethinkdb</a> <a href="/tags/scaling/" style="font-size: 10px;">scaling</a> <a href="/tags/sed/" style="font-size: 10px;">sed</a> <a href="/tags/sequelize/" style="font-size: 10px;">sequelize</a> <a href="/tags/sharding/" style="font-size: 10px;">sharding</a> <a href="/tags/share/" style="font-size: 10px;">share</a> <a href="/tags/shell/" style="font-size: 10px;">shell</a> <a href="/tags/shuffle/" style="font-size: 10px;">shuffle</a> <a href="/tags/sort/" style="font-size: 10px;">sort</a> <a href="/tags/systemd/" style="font-size: 10px;">systemd</a> <a href="/tags/tmux/" style="font-size: 10px;">tmux</a> <a href="/tags/user-group/" style="font-size: 10px;">user group</a> <a href="/tags/velocity/" style="font-size: 10px;">velocity</a> <a href="/tags/web/" style="font-size: 10px;">web</a> <a href="/tags/wsltty/" style="font-size: 10px;">wsltty</a> <a href="/tags/企业平台/" style="font-size: 10px;">企业平台</a> <a href="/tags/前端/" style="font-size: 10px;">前端</a>
					</div>
				</section>
				

				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://github.com/">GitHub</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://tech.meituan.com/">美团点评技术团队</a>
			        
			        </div>
				</section>
				

				
			</div>
		</div>
	</header>
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">crzidea.com</a></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<a href="/" class="profilepic">
                
                <img src="/img/avatar.png" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
                
			</a>
			<hgroup>
			  <h1 class="header-author"><a href="/" title="回到主页">crzidea.com</a></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives/">列表</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
						<ul class="social">
							
								<li id="Email"><a class="Email" target="_blank" href="mailto:micro-tech@foxmail.com" title="Email"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/crzidea" title="GitHub"></a></li>
					        
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/crzidea" title="新浪微博"></a></li>
					        
								<li id="QQ"><a class="QQ" target="_blank" href="http://wpa.qq.com/msgrd?v=3&uin=133683737&site=qq&menu=yes" title="QQ"></a></li>
					        
						</ul>
			</nav>
		</header>
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-update-blog-options-with-sed" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/12/update-blog-options-with-sed/" class="article-date">
  	<time datetime="2016-05-12T08:47:01.000Z" itemprop="datePublished">2016-05-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/12/update-blog-options-with-sed/">使用 sed 修改博客配置项</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>伸手党请跳至本文最后一条命令。</p>
<h2 id="sed基本用法"><a href="#sed基本用法" class="headerlink" title="sed基本用法"></a><code>sed</code>基本用法</h2><p>提到<code>sed</code>，我之前用的最多的用法大概就是：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed <span class="string">'s/old-word/new-word/g'</span> file</div></pre></td></tr></table></figure>
<p>例如，有一篇博客的文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">title: 使用 sed 修改博文配置</div><div class="line">date: 2016-05-12 16:47</div><div class="line">status: draft</div><div class="line">tags: [sed, range, replace, shell, array]</div><div class="line">---</div><div class="line"></div><div class="line">博文开始</div><div class="line">...</div></pre></td></tr></table></figure>
<p>每次上线的时候，都要将上面文件内容的<code>status</code>选项由<code>draft</code>修改为<code>public</code>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed <span class="string">'s/^status:.*/status: public/'</span> blog.md</div></pre></td></tr></table></figure>
<h2 id="使用shell的模板字符串"><a href="#使用shell的模板字符串" class="headerlink" title="使用shell的模板字符串"></a>使用<code>shell</code>的模板字符串</h2><p>但是当我们需要修改时间的时候，又要怎么做呢？<br>这个时候另一个命令行工具就需要登场了：<code>date</code>。</p>
<p>例如，需要按照上面文件内容中的时间格式，输出当前的时间，可以这样搞：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">date +<span class="string">'%Y-%m-%d %H:%M'</span></div></pre></td></tr></table></figure>
<p>把上面的执行结果放入到我们的<code>sed</code>参数中，修改时间的脚本就成了。<br>模板字符串使用双引号，这一点和 php 非常相似。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed <span class="string">"s/^date:.*/date: <span class="variable">$(date +'%Y-%m-%d %H:%M')</span>/"</span> blog.md</div></pre></td></tr></table></figure>
<p>到这里，我们要替换内容的功能，基本上都已经实现了。如果我是一个不严肃、懒惰的工程师，下面的内容可能就不会存在了。</p>
<h2 id="查找边界"><a href="#查找边界" class="headerlink" title="查找边界"></a>查找边界</h2><p>上面的脚本里存在的问题在于，如果你的博客的内容中出现了<code>^update:.*</code>或<code>^date:.*</code>可以匹配到的行，内容就会被错误的修改。例如本篇博客就已经存在这种情况了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">title: 使用 sed 修改博文配置</div><div class="line">date: 2016-05-12 16:47:01</div><div class="line">status: draft</div><div class="line">tags: [sed, range, replace, shell, array]</div><div class="line">---</div><div class="line"></div><div class="line">博文开始</div><div class="line"></div><div class="line">update: xxxx-xx-xx xx:xx</div><div class="line">status: test</div><div class="line">...</div></pre></td></tr></table></figure>
<p>实际上，这里只需要修改两个<code>---</code>之间的内容。<br>那么问题就变成了：「如何找出前两个<code>---</code>的行号？」这地方我绕了一个弯路，下面会解释。<br>查找行号的方法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep -n <span class="string">'^---\s*$'</span> blog.md</div></pre></td></tr></table></figure>
<p>输出的文本虽然对人可读，但是无法直接用它来编程，所以需要处理一下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">head_range_string=$(</div><div class="line">  grep -n <span class="string">'^---\s*$'</span> blog.md |\</div><div class="line">  head -n 2 |\</div><div class="line">  awk -F <span class="string">':'</span> <span class="string">'&#123;print $1&#125;'</span></div><div class="line">)</div></pre></td></tr></table></figure>
<p>处理之后，变量中就只剩下了对我们有用的字符串了。但是字符串毕竟是<strong>一个</strong>变量，想从里面获取到那个数字是开始行号，那个数字是结束行号，还是需要再做一次处理：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">head_range_array=(<span class="variable">$head_range_string</span>)</div><div class="line">head_start=<span class="variable">$&#123;head_range_array[0]&#125;</span></div><div class="line">head_end=<span class="variable">$&#123;head_range_array[1]&#125;</span></div></pre></td></tr></table></figure>
<h2 id="在sed的命令中标记边界"><a href="#在sed的命令中标记边界" class="headerlink" title="在sed的命令中标记边界"></a>在<code>sed</code>的命令中标记边界</h2><p>把得到的变量放到<code>sed</code>的脚本里，边界的问题就可以解决了：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sed -i <span class="string">''</span> <span class="string">"<span class="variable">$&#123;head_start&#125;</span>,<span class="variable">$&#123;head_end&#125;</span> s/^status:.*/status: public/"</span> blog.md</div><div class="line">sed -i <span class="string">''</span> <span class="string">"<span class="variable">$&#123;head_start&#125;</span>,<span class="variable">$&#123;head_end&#125;</span> s/^date:.*/date: <span class="variable">$(date +'%Y-%m-%d %H:%M')</span>/"</span> blog.md</div></pre></td></tr></table></figure>
<p>（<code>-i</code>参数的作用是在原文件操作，结果不输出到终端。）</p>
<h2 id="sed批处理"><a href="#sed批处理" class="headerlink" title="sed批处理"></a><code>sed</code>批处理</h2><p>上面的脚本中，调用了两次<code>sed</code>，实际上会有 4 次 IO（两次读文件，两次写文件）。加入我们要修改的配置项更多，调用次数也会更多。<br>实际上，<code>sed</code>是支持再一次执行中，处理多条命令（command）的。修改后的版本：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed -i <span class="string">''</span> <span class="string">"<span class="variable">$&#123;head_start&#125;</span>,<span class="variable">$&#123;head_end&#125;</span> &#123; s/^date:.*/date: <span class="variable">$(date +'%Y-%m-%d %H:%M')</span>/; s/^status:.*/status: publish/; &#125;"</span> blog.md</div></pre></td></tr></table></figure>
<h2 id="让sed自己查找边界"><a href="#让sed自己查找边界" class="headerlink" title="让sed自己查找边界"></a>让<code>sed</code>自己查找边界</h2><p>上面说饶了一点弯路，实际上我们其实不需要用<code>grep</code>+<code>head</code>+<code>tail</code>+<code>awk</code>+<code>array</code>的组合来查找边界，<code>sed</code>自己就可以根据正则来匹配：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sed -i <span class="string">''</span> <span class="string">"/^---/,/^---/ &#123; s/^date:.*/date: <span class="variable">$(date +'%Y-%m-%d %H:%M')</span>/; s/^status:.*/status: publish/; &#125;"</span> blog.md</div></pre></td></tr></table></figure>
<p>所以刚才写了这么多，最后只用这一条命令就够了。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/array/">array</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/date/">date</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/range/">range</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/replace/">replace</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sed/">sed</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/shell/">shell</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: false,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
    


  
    <article id="post-why-full-stack-is-a-joke-in-China" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/18/why-full-stack-is-a-joke-in-China/" class="article-date">
  	<time datetime="2016-04-18T09:48:04.000Z" itemprop="datePublished">2016-04-18</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/18/why-full-stack-is-a-joke-in-China/">为什么全栈JavaScript经常被黑</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p><a href="https://www.zhihu.com/question/43165251/answer/95491432" target="_blank" rel="external">知乎链接</a></p>
<p>作为一个后端工程师，在前端TC晋升到P6，也想来凑个热热闹。而且我们组的同学，也全部是非常靠谱的全栈，招聘要求也是按照全栈的标准来，比较严格的。</p>
<p>内容预警，写的东西比较尖锐或者刻薄，但我认为是比较<strong>客观</strong>的，所以敢冒着得罪人的风险把这些写下来。</p>
<ul>
<li><strong><em>先来回答“为什么全栈会被黑？”</em></strong><br>很简单，因为<strong>大多数的全栈都很菜</strong>。菜到什么程度这里也不用表述了，估计在大家的认知里，这些都可以脑补。有的连JS都没摸熟，做了一个前后端的WEB项目，写了前后端的代码，就在简历上自称全栈了。<br>这些“菜”的工程师直接拉低了全栈工程师的口碑，以至于每次我在别人面前提到我们团队的工作职责时，我都要特别强调好几遍“是真全栈，不要怀疑。”<br>但是我要强调的是，“大多数”不代表“全部”，和我一起工作的同事，都是按照非常严格的要求筛选出来的，他们是“真正的全栈工程师”。</li>
<li><strong><em>那么问题就变成了“为什么大多数全栈都很菜？”</em></strong><br>这个问题也很简单，就两个原因：<ol>
<li>没机会学习全栈的所有技能。那我们再问为什么没机会？<ol>
<li>即使是打着“招聘全栈工程师”的旗号的一些公司，他们把人招过来之后也是把全栈当前端用。</li>
<li>即便公司想用，但是他们的技术负责人也不一定不会用这种技能的人，于是给他们分配的任务还只是前端的，接触不到其他的全栈技能。</li>
</ol>
</li>
<li>不知道该怎么学习全栈技能。那我们再问为什么不知道该怎么学？<ol>
<li>上面也说了，leader不会用人，不会带人，而leader又是团队的榜样，leader都弄不明白的事情，其他人弄明白了，其他人不成leader了吗？这种现象不太可能发生。</li>
<li>自身动力不足，或者学习能力不够。总之自身因素也是有的。</li>
</ol>
</li>
</ol>
</li>
<li><strong><em>那么，上边提到的对全栈的要求是什么呢？</em></strong><br>我的答案要比列举的技能树要简单的多：<strong>熟悉Linux、熟悉HTTP、熟悉浏览器提供的各种API，并能活用以上三种技能</strong>，完了。</li>
<li>为什么会有这种要求？<ul>
<li>Linux，学习的再多也不为过。原因：</li>
</ul>
<ol>
<li>在一个全栈的团队里面，负责和专业运维沟通的人，必定也是全栈。</li>
<li>在一个全栈的团队里面，负责后端架构、性能优化、高可用、负载均衡设计的人，必定也是全栈。而如果熟悉Linux，对这部分工作内容会有非常大的帮助。有些需要自己解决的问题，可能用Linux中的一些既有功能就可以简单暴力的解决，虽然很暴力但是很有效。</li>
<li>以上都是讲对后端的作用，其实前端也是离不开Linux的，虽然大部分的前端不用Linux。举一个例子，大家都在用fs.watch()的API，或者nodemon、webpack或者其他构建工具的文件监视工具，但是有几个前端知道用shell怎么实现这种文件监视的功能？那我要反问一句，连文件监视功能是怎么实现的都不知道，怎么敢自称“工程师”？或者“前端工程师”？</li>
</ol>
<ul>
<li>HTTP很重要，原因大家都知道的，我就不多说了。但是我要强调的是，学HTTP，对于学习的人来讲，价值更大的是，学习学习协议的方法。<br>就个人的经历而言，除HTTP协议之外，先后学习过engine.io、kafka、redis、amqp、mqtt的协议，其中kafka、redis中大部分的协议内容部是 request-response 的（kafka全部都是，redis中pub-sub不是，答主是kafka-node的作者之一，同时也实现过redis文本协议的parser）。所以如果学习过HTTP，对于学习其他的协议是很有帮助的。</li>
<li>浏览器提供的各种API，这个技能不光是全栈的，而是所有前端应该去学习的，原因我也不赘述。这里说的API，不光是HTML、CSS，存储、网络、传感器、绘图等都应该是前端的技能范围。面试的时候我会想起来什么问什么。但我不会根据这个来判断被面试者的能力。因为下面一点更重要。</li>
<li>“活用以上三种技能”。我再装个大13，前后端分离的项目，大家会怎么定义后端接口的地址？不许修改HOST，不许安装浏览器插件。就这样一个简单的问题，就可能涉及到Linux环境变量或localStorage的问题。这才是全栈最核心的技能，<strong>既要善学，也要善用</strong>。</li>
</ul>
</li>
<li><strong><em>为什么不需要太了解编程语言？</em></strong><br>语言就是工具，而对于能活学善用的人，你需要告诉他工具怎么用吗？如果不用的话，何必要问呢？我面试过一个应届生，ES6中的generator的API，他根本不了解，但是我告诉他API之后，他就能很快的写出类似co的功能。</li>
<li><strong><em>为什么不需要太了解数据库？</em></strong><br>看到评论中有朋友说全栈技能应该包括数据库、神经网络等，我觉得这不是必选项。有的项目用mongodb有的用rethinkdb，数据库在这些项目里就是一个框，在外面看来就是能存能查，保证可扩展和高可用就行，框内是什么大部分人应该都不清楚。有个数据库用blockchain的原理，可以实现百万的并发写入，你会去看blockchain是什么吗？那还装这个13干什么。<br>至于机器学习，额，大家都懂。对于有兴趣的人，会就会了，不值得炫耀，多在上面花点儿时间罢了。但是多数时候用不上。</li>
<li><strong><em>最后，我要得罪一下另一类人群了：写Java的人就没有菜的吗？</em></strong><br>有，当然有，比写JS的菜的更多。甚至是我列出来的<strong>三种基本技能，一种都不能达标的大有人在</strong>。</li>
</ul>
<p>最后，还是希望励志成为“全栈工程师”的同学们不要放弃，坚持自己的学习道路。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/full-stack/">full stack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nodejs/">nodejs</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: false,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
    


  
    <article id="post-build-gamepadgo-with-250-lines" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/12/build-gamepadgo-with-250-lines/" class="article-date">
  	<time datetime="2016-04-12T07:13:31.000Z" itemprop="datePublished">2016-04-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/12/build-gamepadgo-with-250-lines/">从海淘零件谈起如何造一个机器人</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p><img src="/img/从海淘零件谈起如何造一个机器人.001.jpeg" alt="从海淘零件谈起如何造一个机器人"></p>
<p>相关链接：</p>
<ul>
<li><a href="https://onedrive.live.com/redir?resid=54561A1F3D9AD481!7011&amp;authkey=!AIdznI5NtRXvm28&amp;ithint=file%2ckey" target="_blank" rel="external">KEYNOTE</a></li>
<li><a href="https://onedrive.live.com/redir?resid=54561A1F3D9AD481!7013&amp;authkey=!AJpOr09DZ7rpGJs&amp;ithint=file%2cpdf" target="_blank" rel="external">PDF</a></li>
<li><a href="https://www.zhihu.com/question/20212369/answer/94933812" target="_blank" rel="external">实物图</a></li>
</ul>
<p><em>github</em>:</p>
<ul>
<li><a href="https://github.com/crzidea/gamepadgo-server" target="_blank" rel="external">crzidea/gamepadgo-server</a></li>
<li><a href="https://github.com/crzidea/gamepadgo-client" target="_blank" rel="external">crzidea/gamepadgo-client</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gamepad/">gamepad</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gopigo/">gopigo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nodejs/">nodejs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/raspberry-pi/">raspberry pi</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: false,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
    


  
    <article id="post-FEDAY-2016" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/31/FEDAY-2016/" class="article-date">
  	<time datetime="2016-03-31T03:06:25.000Z" itemprop="datePublished">2016-03-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/31/FEDAY-2016/">FEDAY 2016 参会总结</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>本来只想写一个“正面反应版”。但是有问题不问，有不足不说，会议组织方也很高兴，明年照样收费办个场，内容照样水，组织照样混乱，那这种会就成了骗钱的了。所以写着写着就成“客观评价版”了。</p>
<p><a href="http://www.fequan.com/2016/#ppt" target="_blank" rel="external">PPT链接</a></p>
<h2 id="嘉宾"><a href="#嘉宾" class="headerlink" title="嘉宾"></a>嘉宾</h2><p>参加这种会议，讲师的名字一定要记住。这次令人印象深刻的嘉宾阵容包括：</p>
<ul>
<li>周裕波（会议负责人）<br>这次会议由很多失误，这些失误与会议负责人是有直接关系的。</li>
<li>高博（翻译官）<br>首先必须要给高博点个赞，尤其是在最后一场讲“HTTP/2”的时候，有很多大段翻译，有的时候一段翻译跨越了5页（或更多，没仔细数）PPT。但是其实我认为，如果没有翻译，演讲的效果可能更连贯，更利于“听得懂英语”的同学理解。</li>
<li>江剑锋（讲师，来自微信，分享主题：微信Web APP开发最佳实践）<br>这次分享最有价值的分享内容，我认为必须要给这位来自微信的同学。一句话评价分享内容：干货十足，数据价值爆表，演讲风格幽默。</li>
<li>Stepan（讲师，来自facebook，分享主题：使用React、Redux和Node.js构建通用应用）<br>分享内容没什么含金量。但是作为“会讲中文”的外宾，还是给大家带来了不少段子。我对他印象深刻的理由也就仅限于此了。</li>
<li>黄士旗（讲师，来自facebook，分享主题：React tips）<br>我看到这个标题的时候，就觉得含金量不高。但是有一部分内容的思想是非常值得借鉴的，例如HOC，虽然简单，讲出来概念大家都明白，“不就是一种代码组织方式吗？”，但是只有极少数人把这个概念用好。</li>
</ul>
<h2 id="分享内容精编"><a href="#分享内容精编" class="headerlink" title="分享内容精编"></a>分享内容精编</h2><p>取其精华，去其不精华（糟粕？我还是委婉一些吧）。</p>
<h3 id="微信Web-APP开发最佳实践"><a href="#微信Web-APP开发最佳实践" class="headerlink" title="微信Web APP开发最佳实践"></a>微信Web APP开发最佳实践</h3><ul>
<li>Android端，微信用户中，数量排前5的设备全是小米和三星。<br>（讲师：有些大厂一定表示不服，但是不服我们也没有什么办法，统计到的数据就是这个样子。）<br>其他数据要看PPT吧。</li>
<li>吐槽了很多X5内核的BUG。BUG太多了，这部分回头看PPT就行。<br>QA环节有人问为什么吴亦凡的活动，视频可以自动播放，有没有什么技巧可以绕过。讲师回答：其实没有技巧，其实就是白名单（台下笑）。</li>
<li>X5 BUG那么多，最后讲师给出了一个终极解决方案：微信将在4月初升级X5，内核由webkit改为blink，很多BUG就都不存在了。目前还在灰度放量中。<br>（讲师：如果有人说他有4-5年微信APP开发经验，那他一定是再骗你。因为从4月初，以前的经验都没用了。）</li>
</ul>
<p>由X5升级引发的一些感想：要做有前途的前端，真的不能把兼容性当成一个研究方向。要不然在别人学习、接受新东西的时候，你只会在原地踏步。</p>
<h3 id="React-tips"><a href="#React-tips" class="headerlink" title="React tips"></a>React tips</h3><p>关键词：HOC（Higher-order Component）</p>
<p>变种：HOF（Higher-order Function）、HOC（Higher-order Class）</p>
<p>用最简洁的代码示范一下，我们以前的组件代码组织方式大概是这个样子：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> input = createInput()</div><div class="line">  <span class="keyword">var</span> checkbox = createCheckbox(input)</div><div class="line">  <span class="keyword">var</span> buttonDelete = createButtonDelete(input)</div><div class="line">  <span class="keyword">return</span> (</div><div class="line">    <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></div><div class="line">	  &#123;checkbox&#125;</div><div class="line">      &#123;input&#125;</div><div class="line">      &#123;buttonDelete&#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  )</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而HOC的姿势是这个样子的：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> input = createInput()</div><div class="line">  input = makeCheckable(input)</div><div class="line">  input = makeDeletable(input)</div><div class="line">  <span class="keyword">return</span> (</div><div class="line">    <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></div><div class="line">      &#123;input&#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  )</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>初看不就是一种“代码组织方式吗？”，但是引起我注意的是，又有几个人会想到用这种组织方式？或者用过？用好？</p>
<p>这种组织方式是高度可扩展的，我这里只是自己写了一个示例，但是用到工程中之后，带来的生产力收益会非常大。</p>
<h2 id="会议组织失误"><a href="#会议组织失误" class="headerlink" title="会议组织失误"></a>会议组织失误</h2><ul>
<li>Winter到了会场才写PPT。</li>
<li>投影设备频出故障。讲师演示的时候也很尴尬。而且一直到下午最后一场，还会出问题，不能马上解决。</li>
<li>午餐组织地相当失误。本来没有午餐，但是可能是因为收的门票钱有结余，所以主办方给大家加了午餐。但是太混乱了：<ul>
<li>6个人的桌，我们坐了5个人，服务员非要再拉3个不认识的人过来，这就一桌8认了。一个桌2个火锅，搞得我们这边坐在另一个火锅前的同学非常尴尬，靠着别人的锅，但是要到我们这边来夹菜。</li>
<li>服务员要求参会嘉宾把盘子里的吃完了再去拿菜。</li>
<li>纸巾需要收费。很少有见到纸巾收费的饭店。</li>
</ul>
</li>
<li>领发票时场面会乱，无组织无纪律。而且，要发票还需要单独收钱！！！我排了好久的队，结果告诉我没有我们的发票！</li>
</ul>
<h2 id="会后收获"><a href="#会后收获" class="headerlink" title="会后收获"></a>会后收获</h2><p>会议结束之后，与守强、张虓一起吃了晚饭。然后我提出来（也是咨询前辈）几个问题：</p>
<h3 id="技术团队应该花多少资源在基础技术建设上？"><a href="#技术团队应该花多少资源在基础技术建设上？" class="headerlink" title="技术团队应该花多少资源在基础技术建设上？"></a>技术团队应该花多少资源在基础技术建设上？</h3><p>说几个现状：</p>
<ul>
<li>某兄弟团队在基础技术建设上的投入是0。</li>
<li>我们业务开发和基础技术上的投入比大概是8:2。</li>
<li>腾讯在技术上，对外是基本上没有输出的。</li>
<li>facebook有1000名工程师在维护react。</li>
</ul>
<p>对比之后，我个人的结论是：业务开发团队，在基础技术建设上的投入应该小于2/10，尤其是小型团队，更是如此。但是当团队到达一定规模时，这个投入是免不了的，就算不输出（比如腾讯），也要做投入一些资源做基础技术为业务服务。</p>
<h3 id="技术团队的梯度该如何设置？"><a href="#技术团队的梯度该如何设置？" class="headerlink" title="技术团队的梯度该如何设置？"></a>技术团队的梯度该如何设置？</h3><p>我了解到的一些部门的情况：</p>
<ul>
<li>杨自强老师在高工培训的课上讲过的，理想情况下，团队梯度P7:P6:P5:P4=1:2:2:2。依据是P7要独当两面，两个P6一人帮他挡一面，然后每个P6带一个P5和P4。这是理想情况。</li>
<li>我们团队，一共5个RD（不算锋哥），1 P6，2 P5，2 P4。之前我还跟锋哥讨论过，以为和理想情况偏差的已经很大了。</li>
<li>某兄弟团队，一共20个人，有2 P6，10+ P5。</li>
<li>某兄弟团队，一共20个人，其中只有一个P6。</li>
</ul>
<p>从上面的梯度数据，我个人的结论就不讲了。但是反映出来的一个问题是，我们的业务开发部门，在梯度上的质量是远远不够的，而且可能永远都达不到理想情况。如果一个公司既不在梯度质量上投入资源，又不在基础技术上投入资源，工程的质量就很不乐观了。当然我们公司的投入还是很多的，技术工程部就是专门为后者而设立的。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FEDAY/">FEDAY</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: false,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
    


  
    <article id="post-用正确的姿势在分布式的构建环境中优化-nodejs-项目部署速度" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/29/用正确的姿势在分布式的构建环境中优化-nodejs-项目部署速度/" class="article-date">
  	<time datetime="2016-03-29T03:58:44.000Z" itemprop="datePublished">2016-03-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/29/用正确的姿势在分布式的构建环境中优化-nodejs-项目部署速度/">用正确的姿势在分布式的构建环境中优化 nodejs 项目部署速度</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>拆解一下标题：</p>
<ul>
<li>优化nodejs项目部署速度</li>
<li>在分布式的构建环境中</li>
<li>用正确的姿势</li>
</ul>
<h2 id="三个阶段"><a href="#三个阶段" class="headerlink" title="三个阶段"></a>三个阶段</h2><table>
<thead>
<tr>
<th>Deploy At</th>
<th>Time Spend</th>
</tr>
</thead>
<tbody>
<tr>
<td>2015-12-10</td>
<td>6s</td>
</tr>
<tr>
<td>2016-03-11</td>
<td>240s</td>
</tr>
<tr>
<td>2016-03-28</td>
<td>53s</td>
</tr>
</tbody>
</table>
<h3 id="第一阶段：单机构建、单机上线"><a href="#第一阶段：单机构建、单机上线" class="headerlink" title="第一阶段：单机构建、单机上线"></a>第一阶段：单机构建、单机上线</h3><p><img src="/img/20160329/20160329.001.jpeg" alt=""></p>
<p>这是我们最早的部署流程。线上只有一台机器，我们可以登录这台机器，然后手动的安装一些通用依赖（比如node、npm、nginx），<strong>甚至是项目的package.json中的依赖</strong>，就已经可以跑起来了。</p>
<p>但是这个部署流程的问题非常严重（已在上图标出）：</p>
<ul>
<li><strong>没有扩展性可言。</strong>一旦要加机器，必须登录新机器，手动把依赖装一遍。加一台两台还好，加个5、6台，挨个机器登录装依赖烦死你。尤其是在我们这种有事没事儿给你搞个机房下线、域名乱改的生存环境中，到之后对接运维工作的人只能呵呵啊！</li>
<li><strong>依赖更新不及时。</strong>原则上，我们的依赖应该要与社区的stable按本对齐的。可是有几个团队保持这种原则？原因略过。就算是你不想更新，那天社区爆出了一个安全漏洞，你也不得不去更新。到之后怎么办？再挨个机器登录更新依赖？到时候一样只能呵呵啊！</li>
</ul>
<p>这一阶段，部署一次，大概花费6秒左右。</p>
<h3 id="第二阶段：多机构建、多机上线"><a href="#第二阶段：多机构建、多机上线" class="headerlink" title="第二阶段：多机构建、多机上线"></a>第二阶段：多机构建、多机上线</h3><p><img src="/img/20160329/20160329.002.jpeg" alt=""></p>
<p>后来我把发布的流程改成了这个样子（<strong>标黄的内容是做的修改</strong>）。抹平了上一个阶段的坑（然后又砸出了几个坑）。</p>
<p>把安装依赖的过程放到构建机来做，这样做：</p>
<ul>
<li>不需要跑到每个机器上安装依赖。因为安装依赖已经在重启服务的脚本里了。</li>
<li>保证了每次上线的时候，依赖都是和社区的stable版本对齐的。</li>
</ul>
<p>但是又出现了新的问题：</p>
<ul>
<li><strong>构建机安装依赖的时间非常长。</strong>我们每次点击了“我要部署”的按钮之后，都要等构建机器安装好了最新的依赖（2-5分钟），才能进入发布文件的流程。</li>
<li>多个项目的构建脚本和重启脚本维护起来比较困难。但是这些脚本的内容很多是重复的。比如几乎所有项目的pre-deploy.sh的脚本内容都是一样的，再比如每个脚本基本上都要检查nvm、node的版本并执行npm install。</li>
</ul>
<p>这一阶段，部署一次，大概花费240秒左右。</p>
<h3 id="第三阶段：优化后"><a href="#第三阶段：优化后" class="headerlink" title="第三阶段：优化后"></a>第三阶段：优化后</h3><p>这一阶段是我们要探讨的主要问题是，我们不能接受上线一次需要花费240秒（有时甚至是300秒）。</p>
<p>那我们该怎么做呢？</p>
<h2 id="找出“岁月神偷”"><a href="#找出“岁月神偷”" class="headerlink" title="找出“岁月神偷”"></a>找出“岁月神偷”</h2><figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[2016<span class="string">-03</span><span class="string">-11</span> 15:25:44] =&gt; npm install</div><div class="line">...</div><div class="line">[2016<span class="string">-03</span><span class="string">-11</span> 15:28:52] =&gt; bower install</div></pre></td></tr></table></figure>
<p>以上是从部署入职里摘出来的一部分。真的留意的是“…”上下的时间，一共花费了188秒。</p>
<p>npm install 的确很慢，但是每次都慢吗？</p>
<p>其实npm发现当前项目目录中已经有node_modules目录的时候，是会检查（虽然检查的很慢）那些依赖已经被安装过了的。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ time npm install</div><div class="line"><span class="built_in">..</span>.</div><div class="line"></div><div class="line">real    0m11.685s<span class="built_in"></span></div><div class="line">user    0m11.411s</div><div class="line">sys     0m1.110s</div></pre></td></tr></table></figure>
<p>这就说明其实构建机并没有保存我们上一次的构建结果，每次部署结束之后，构建结果都会被自动清理掉。</p>
<p>之后我又向维护OPS的同学求证了一下，构建结果其实有保存，是保存在了云存储上。但是并没有给我们开放获取构建结果的途径。</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[2016<span class="string">-03</span><span class="string">-28</span> 11:44:32] Upload build/mit.blog/mit.blog<span class="string">-2016</span><span class="string">-03</span><span class="string">-28</span><span class="string">-11</span><span class="string">-43</span><span class="string">-56</span>.tar.gz ...</div><div class="line">[2016<span class="string">-03</span><span class="string">-28</span> 11:44:37] Upload build/mit.blog/mit.blog<span class="string">-2016</span><span class="string">-03</span><span class="string">-28</span><span class="string">-11</span><span class="string">-43</span><span class="string">-56</span>.tar.gz success!</div></pre></td></tr></table></figure>
<p><del>（丫的，不让我们用还占用了我们5s的时间。5s，5s我都可以上天了！）</del></p>
<p>总结一下我们在构建这件事情上遇到的问题：</p>
<ul>
<li>构建机器是分布式的。会从一个集群中随机抽取一台来处理我们的构建请求。</li>
<li>构建机器上的构建结果会被保存，但是我们无法获取。</li>
<li>即使我们使用了缓存的构建结果，npm检查的速度依然很慢。</li>
</ul>
<h2 id="抄近道"><a href="#抄近道" class="headerlink" title="抄近道"></a>抄近道</h2><p>超车哪有不粗暴的？针对上面遇到的问题，我就是要用粗暴的方式搞定。</p>
<h3 id="近道一：自建服务器缓存构建结果"><a href="#近道一：自建服务器缓存构建结果" class="headerlink" title="近道一：自建服务器缓存构建结果"></a>近道一：自建服务器缓存构建结果</h3><p><img src="/img/20160329/20160329.003.jpeg" alt=""></p>
<p>核心思路是把构建结果缓存起来，实现188s（无node_modules） =&gt; 11s （有node_modules）的依赖安装过程优化。</p>
<h3 id="近道二：使用更粗暴的方式比对项目依赖是否需要更新"><a href="#近道二：使用更粗暴的方式比对项目依赖是否需要更新" class="headerlink" title="近道二：使用更粗暴的方式比对项目依赖是否需要更新"></a>近道二：使用更粗暴的方式比对项目依赖是否需要更新</h3><p><img src="/img/20160329/20160329.004.jpeg" alt=""></p>
<p>这就更暴力了，直接把现在的package.json和之前有构建结果的package.json进行文本比对，再最理想的情况下，可以直接干掉npm检查本地node_modules的时间，实现11s（使用npm install检查） =&gt; 0s（使用diff检查）的依赖安装过程的优化。</p>
<p>（上图中，实现表示理想情况，虚线表示需要重新安装依赖的情况。）</p>
<h2 id="部署速度不是全部的财富"><a href="#部署速度不是全部的财富" class="headerlink" title="部署速度不是全部的财富"></a>部署速度不是全部的财富</h2><p>需要注意的是，我们优化之后仍然不会恢复到之前5s上线的速度，因为我们做了一系列的严格环境检查：</p>
<ul>
<li>对构建环境的node版本做了检查。</li>
<li>对线上环境的node版本做了检查。</li>
<li>线上机器是分布式的环境，会对服务进行轮流重启。每重启一批机器，大概需要花费7秒。一般情况下，不管服务器有几台，都会分两批重启（保持一批持续提供服务），所以一般会花费14秒在重启服务商。</li>
<li>OPS把构建结果上传到了云存储。不受我们控制，每次消耗5秒（还不给我们用）。</li>
<li>除上述之外，OPS准备时间花费了14秒。</li>
</ul>
<p>这样算下来，到现在为止，我们自己在构建上花费的时间真的就只有不到20（53-14-5-14）秒了，未来我们会干掉bower，还会再减7秒。而且建立了非常稳健的环境检查机制，这比单纯追求速度更有价值。</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[<span class="number">2016</span>-<span class="number">03</span>-<span class="number">28</span> <span class="number">11</span>:<span class="number">44</span>:<span class="number">12</span>] [localhost] local: /bin/bash -l -c <span class="string">"./bin/pre-deploy.sh"</span></div><div class="line">...</div><div class="line">[<span class="number">2016</span>-<span class="number">03</span>-<span class="number">28</span> <span class="number">11</span>:<span class="number">44</span>:<span class="number">13</span>] Downloading http://npm.sankuai.com/dist/<span class="keyword">node</span><span class="title">/v5</span>.<span class="number">9.1</span>/<span class="keyword">node</span><span class="title">-v5</span>.<span class="number">9.1</span>-linux-x64.tar.xz...</div><div class="line">...</div><div class="line">[<span class="number">2016</span>-<span class="number">03</span>-<span class="number">28</span> <span class="number">11</span>:<span class="number">44</span>:<span class="number">13</span>] WARNING: checksums are currently disabled for <span class="keyword">node</span>.<span class="title">js</span> v4.<span class="number">0</span> <span class="keyword">and</span> later</div><div class="line">[<span class="number">2016</span>-<span class="number">03</span>-<span class="number">28</span> <span class="number">11</span>:<span class="number">44</span>:<span class="number">16</span>] Now using <span class="keyword">node</span> <span class="title">v5</span>.<span class="number">9.1</span> (npm v3.<span class="number">7.3</span>)</div><div class="line">...</div><div class="line">[<span class="number">2016</span>-<span class="number">03</span>-<span class="number">28</span> <span class="number">11</span>:<span class="number">44</span>:<span class="number">21</span>] modules are loaded fram sankuai@<span class="number">10.4</span>.<span class="number">232.99</span>:~/.tmp/mtblog/</div></pre></td></tr></table></figure>
<blockquote>
<p>对构建环境的node版本做了检查</p>
</blockquote>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[<span class="number">2016</span><span class="number">-03</span><span class="number">-28</span> <span class="number">11</span>:<span class="number">44</span>:<span class="number">40</span>] [server1] run: ./bin/post-deploy.sh</div><div class="line">...</div><div class="line">[<span class="number">2016</span><span class="number">-03</span><span class="number">-28</span> <span class="number">11</span>:<span class="number">44</span>:<span class="number">44</span>] [server1] out: [<span class="symbol">PM2</span>] <span class="symbol">Done</span>.</div></pre></td></tr></table></figure>
<blockquote>
<p>每重启一批机器，大概需要花费9秒。</p>
</blockquote>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[<span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">15</span>:<span class="number">28</span>:<span class="number">52</span>] =&gt; <span class="keyword">bower </span>install</div><div class="line">[<span class="number">2016</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">15</span>:<span class="number">28</span>:<span class="number">59</span>] <span class="keyword">bower </span><span class="keyword">breakpoint-sass#~2.6.1 </span>ENOTFOUND Request to https://<span class="keyword">bower.herokuapp.com/packages/breakpoint-sass </span>failed: getaddrinfo ENOTFOUND</div></pre></td></tr></table></figure>
<blockquote>
<p>未来我们会干掉bower，还会再减7秒。</p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/build/">build</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/deploy/">deploy</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/distribution/">distribution</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nodejs/">nodejs</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: false,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
    


  
    <article id="post-memory-leak-in-javascript" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/02/24/memory-leak-in-javascript/" class="article-date">
  	<time datetime="2016-02-24T07:21:09.000Z" itemprop="datePublished">2016-02-24</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/24/memory-leak-in-javascript/">不要人言亦言，合理处理 nodejs 的内存问题</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>很多人都说 nodejs 的 GC 特别渣，我也觉得渣。例如：</p>
<ul>
<li><p><a href="https://github.com/shadowsocks/shadowsocks-nodejs" target="_blank" rel="external">shadowsocks 作者因为不满 nodejs 的 GC，直接放弃了维护 node 版本</a></p>
<blockquote>
<p>The GC of node.js sucks.</p>
<p>Python version handles 5000 connections with 50MB RAM while node.js version handles 100 connections with 300MB RAM. Why should we continue to support node.js?</p>
</blockquote>
</li>
<li><p><a href="http://stackoverflow.com/questions/5603011/node-js-and-v8-garbage-collection" target="_blank" rel="external">很多新人都认为 nodejs 的 GC 并不科学，不适用于生产环境</a></p>
<blockquote>
<p>If this is running for production code, that’s a few seconds for 10,000 users.</p>
<p>Is this really acceptable in production environment?</p>
</blockquote>
</li>
<li>我亲眼目睹的一个项目直接断言 nodejs 不适合处理计算密集型的任务，把用 nodejs 做好的服务换成了 java</li>
<li>尤其是最近用写了一个<a href="https://github.com/crzidea/index-net" target="_blank" rel="external">分析数据的项目</a>，发现50M的文本数据被转来转去之后，竟然被 node 进程吃掉3G的内存然后自己死掉了。</li>
</ul>
<p>但是要明确一点：<strong><em>怎么用/用成什么样,和 nodejs、v8、项目都没有关系。大部分的问题来自于开发者自己。</em></strong>用不好不能怨别人。</p>
<h2 id="什么时候出现内存泄露"><a href="#什么时候出现内存泄露" class="headerlink" title="什么时候出现内存泄露"></a>什么时候出现内存泄露</h2><p>对比一下下面的两段代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">notLeakMemory</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> bigData = <span class="built_in">Array</span>(<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">16</span>).map(<span class="function"><span class="params">()</span> =&gt;</span> <span class="number">0</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = <span class="number">16</span>; i &lt; l; i++) &#123;</div><div class="line">  notLeakMemory()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">leakMemory</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> bigData = <span class="built_in">Array</span>(<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">16</span>).map(<span class="function"><span class="params">()</span> =&gt;</span> <span class="number">0</span>)</div><div class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    bigData   <span class="comment">// leak</span></div><div class="line">  &#125;, <span class="number">3600000</span>) <span class="comment">// 1 hour</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = <span class="number">16</span>; i &lt; l; i++) &#123;</div><div class="line">  leakMemory()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>分别运行一下就会知道，<code>notLeakMemory()</code>跑个一年半载也不会出现进程挂掉的情况，而<code>leakMemory()</code>运行16次之后进程就挂掉了（以下是最后的错误输出）。</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&lt;--- Last few GCs -<span class="function">--&gt;</span></div><div class="line"></div><div class="line">   <span class="number">41914</span> ms: Scavenge <span class="number">2179.9</span> <span class="function"><span class="params">(<span class="number">2217.4</span>)</span> -&gt;</span> <span class="number">2179.9</span> (<span class="number">2217.4</span>) MB, <span class="number">0.3</span> / <span class="number">0</span> ms (+ <span class="number">9.5</span> ms <span class="keyword">in</span> <span class="number">1</span> steps since last GC) [allocation failure] [incremental marking delaying mark-sweep].</div><div class="line">   <span class="number">42584</span> ms: Mark-sweep <span class="number">2179.9</span> <span class="function"><span class="params">(<span class="number">2217.4</span>)</span> -&gt;</span> <span class="number">2051.8</span> (<span class="number">2089.4</span>) MB, <span class="number">670.5</span> / <span class="number">0</span> ms (+ <span class="number">18.5</span> ms <span class="keyword">in</span> <span class="number">7</span> steps since start <span class="keyword">of</span> marking, biggest step <span class="number">9.5</span> ms) [last resort gc].</div><div class="line">   <span class="number">43285</span> ms: Mark-sweep <span class="number">2051.8</span> <span class="function"><span class="params">(<span class="number">2089.4</span>)</span> -&gt;</span> <span class="number">2051.8</span> (<span class="number">2089.4</span>) MB, <span class="number">701.1</span> / <span class="number">0</span> ms [last resort gc].</div><div class="line"></div><div class="line"></div><div class="line">&lt;--- JS stacktrace -<span class="function">--&gt;</span></div><div class="line"></div><div class="line">==== JS stack trace =========================================</div><div class="line"></div><div class="line">Security context: <span class="number">0x3bc199de3ac1</span> &lt;JS Object&gt;</div><div class="line">    <span class="number">1</span>: <span class="comment">/* anonymous */</span>(aka <span class="comment">/* anonymous */</span>) [vm.js:<span class="number">39</span>] [pc=<span class="number">0x27aef1c738fe</span>] (<span class="keyword">this</span>=<span class="number">0x3bc199d04189</span> &lt;<span class="literal">undefined</span>&gt;,code=<span class="number">0x670b6007161</span> &lt;String[<span class="number">5</span>]: Debug&gt;)</div><div class="line">    <span class="number">2</span>: ensureDebugIsInitialized(aka ensureDebugIsInitialized) [util.js:<span class="number">194</span>] [pc=<span class="number">0x27aef1c7379b</span>] (<span class="keyword">this</span>=<span class="number">0x3bc199d04189</span> &lt;<span class="literal">undefined</span>&gt;)</div><div class="line">    <span class="number">3</span>: inspectPromise(aka inspectPromise) [util.js:<span class="number">200</span>] [pc=<span class="number">0x27aef1c73441</span>] (<span class="keyword">this</span>=<span class="number">0x3bc199d04189</span> &lt;<span class="literal">undefined</span>&gt;,p=<span class="number">0xe72ae11</span>...</div><div class="line"></div><div class="line">FATAL ERROR: CALL_AND_RETRY_LAST Allocation failed - process out <span class="keyword">of</span> memory</div></pre></td></tr></table></figure>
<h2 id="为什么会出现内存泄漏"><a href="#为什么会出现内存泄漏" class="headerlink" title="为什么会出现内存泄漏"></a>为什么会出现内存泄漏</h2><p>一句话概括：<em>当存在<strong>可被访问的函数</strong>引用了<strong>函数外的变量</strong>之后，该变量不会被<strong>自动回收</strong>。</em></p>
<h2 id="如何避免-修复内存泄漏"><a href="#如何避免-修复内存泄漏" class="headerlink" title="如何避免/修复内存泄漏"></a>如何避免/修复内存泄漏</h2><p>上面的这句话虽然短，但是有几个地方是可以留意并修复避免/修复内存泄漏的。</p>
<h3 id="“可被访问的函数”"><a href="#“可被访问的函数”" class="headerlink" title="“可被访问的函数”"></a>“可被访问的函数”</h3><p>当函数不再是“可被访问的”，引用的变量也会被释放。举个例子，把上面出错代码中的延时从3600000调整为0：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">leakMemory</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> bigData = <span class="built_in">Array</span>(<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">16</span>).map(<span class="function"><span class="params">()</span> =&gt;</span> <span class="number">0</span>)</div><div class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    bigData</div><div class="line">  &#125;, <span class="number">0</span>) <span class="comment">// run now!</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = <span class="number">16</span>; i &lt; l; i++) &#123;</div><div class="line">  leakMemory()</div><div class="line">&#125;</div><div class="line"><span class="comment">// no error any more</span></div></pre></td></tr></table></figure>
<p>匿名函数被<code>setTimeout()</code>调用之后，该函数的引用将被<code>setTimeout()</code>删除，此时匿名函数就不再是“可被访问的函数”了，所以变量占用的空间会被自动回收掉，就不会造成<code>process out of memory</code>的错误了。</p>
<p>除了<code>setTimeout()</code>之外，还有一些场景会自动删除函数引用：</p>
<ul>
<li><p>使用<code>clearInterval()</code>/<code>clearTimeout()</code>清除了创建的<code>timer</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">leakMemory</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> bigData = <span class="built_in">Array</span>(<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">16</span>).map(<span class="function"><span class="params">()</span> =&gt;</span> <span class="number">0</span>)</div><div class="line">  <span class="keyword">var</span> timer = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    bigData</div><div class="line">  &#125;, <span class="number">3600000</span>)</div><div class="line">  clearTimeout(timer)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = <span class="number">16</span>; i &lt; l; i++) &#123;</div><div class="line">  leakMemory()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>数组的方法（例如<code>.forEach()</code>、<code>.map()</code>等）也会在运行完函数之后删除回调函数的引用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">leakMemory</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> bigData = <span class="built_in">Array</span>(<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">16</span>).map(<span class="function"><span class="params">()</span> =&gt;</span> <span class="number">0</span>)</div><div class="line">  <span class="keyword">var</span> array = [<span class="number">1</span>, <span class="number">2</span>]</div><div class="line">  array.map(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    bigData</div><div class="line">  &#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = <span class="number">16</span>; i &lt; l; i++) &#123;</div><div class="line">  leakMemory()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="“函数外的变量”"><a href="#“函数外的变量”" class="headerlink" title="“函数外的变量”"></a>“函数外的变量”</h3><p>这一点比较好理解，假如我们不访问函数外的变量，也不会造成内存泄露。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">leakMemory</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> bigData = <span class="built_in">Array</span>(<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">16</span>).map(<span class="function"><span class="params">()</span> =&gt;</span> <span class="number">0</span>)</div><div class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    <span class="keyword">var</span> bigData <span class="comment">// prevent leak</span></div><div class="line">  &#125;, <span class="number">3600000</span>)</div><div class="line">&#125;</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = <span class="number">16</span>; i &lt; l; i++) &#123;</div><div class="line">  leakMemory()</div><div class="line">&#125;</div><div class="line"><span class="comment">// no error any more</span></div></pre></td></tr></table></figure>
<h3 id="“自动回收”"><a href="#“自动回收”" class="headerlink" title="“自动回收”"></a>“自动回收”</h3><p>当变量 GC 不能被自动回收时，我们需要手动将变量释放掉：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">leakMemory</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> bigData = <span class="built_in">Array</span>(<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">16</span>).map(<span class="function"><span class="params">()</span> =&gt;</span> <span class="number">0</span>)</div><div class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    bigData        <span class="comment">// bigData no longer holds big data</span></div><div class="line">  &#125;, <span class="number">3600000</span>)</div><div class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    bigData = <span class="literal">null</span> <span class="comment">// release resource</span></div><div class="line">  &#125;,<span class="number">0</span>)</div><div class="line">&#125;</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = <span class="number">16</span>; i &lt; l; i++) &#123;</div><div class="line">  leakMemory()</div><div class="line">&#125;</div><div class="line"><span class="comment">// no error any more</span></div></pre></td></tr></table></figure>
<h2 id="灵丹妙药"><a href="#灵丹妙药" class="headerlink" title="灵丹妙药"></a>灵丹妙药</h2><ul>
<li>如果遇到和<code>v8</code>、<code>gc</code>相关的参数问题，首先使用<code>node --v8-options | less</code>获得帮助</li>
<li>不要过早优化内存使用。1.7G 内存不够用时，尝试使用<code>--max_old_space_size</code>调整老生区大小。</li>
<li>调大新生区，可以减少 GC 阻塞进程的时间。可以通过<code>--max_new_space_size</code>设置</li>
<li>使用<code>--trace_gc</code>参数查看 GC 的活动情况。</li>
<li>使用 <a href="https://github.com/node-inspector/node-inspector" target="_blank" rel="external">node-inspector</a> 的内存快照功能，可以分析出不正常的内存使用。</li>
<li>当且仅当 node 进程需要<strong>给系统中其他进程让出内存</strong>时，使用<code>--expose_gc</code>参数，手动调用<code>gc()</code>。我仍然相信绝大多数时候你不需要使用它。</li>
<li>除了上述提到的几个示例外，<a href="https://github.com/crzidea/crzidea.github.io/tree/edit/example/memory-leak" target="_blank" rel="external">这里还有一些JavaScript内存泄漏的典型示例</a>。</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/memory-leak/">memory leak</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nodejs/">nodejs</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: false,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
    


  
    <article id="post-nodejs-中的几个-API-变化" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/11/23/nodejs-中的几个-API-变化/" class="article-date">
  	<time datetime="2015-11-23T12:42:36.000Z" itemprop="datePublished">2015-11-23</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/23/nodejs-中的几个-API-变化/">nodejs 中的几个 API 变化</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>这些是后端该关注的，前端请按 Ctrl+W。</p>
<h2 id="Cluster"><a href="#Cluster" class="headerlink" title="Cluster"></a>Cluster</h2><ul>
<li><a href="https://nodejs.org/dist/v0.12.7/docs/api/cluster.html" target="_blank" rel="external">文档v0.12</a></li>
<li><a href="https://nodejs.org/api/cluster.html" target="_blank" rel="external">文档v5.1</a></li>
<li>相关模块：<a href="https://github.com/Unitech/pm2" target="_blank" rel="external">PM2</a></li>
<li>应用场景：部署后端服务</li>
<li>关注原因：在v0.12中稳定性为 <strong>2 - Unstable</strong> 而在v5.1中已经变为 <strong>2 - Stable</strong>。换句话说，我们不必担心将它用在线上环境会产生bug了。</li>
</ul>
<p>顺便打脸前段时间的一篇微博：<a href="http://weibo.com/2214851453/D2pb28ybL?from=page_1005052214851453_profile&amp;wvr=6&amp;mod=weibotime&amp;type=comment" target="_blank" rel="external">《当我们谈论 cluster 时我们在谈论什么(上)》</a>，原文及下篇中显然没有意识到nodejs中已经悄悄更新了cluster的实现。<br>分发策略：</p>
<blockquote>
<p>The cluster module supports two methods of distributing incoming connections.<br>The first one (and the default one on all platforms except Windows), is the round-robin approach, where the master process listens on a port, accepts new connections and distributes them across the workers in a round-robin fashion, with some built-in smarts to avoid overloading a worker process.<br>The second approach is where the master process creates the listen socket and sends it to interested workers. The workers then accept incoming connections directly.<br>The second approach should, in theory, give the best performance. In practice however, distribution tends to be very unbalanced due to operating system scheduler vagaries. Loads have been observed where over 70% of all connections ended up in just two processes, out of a total of eight.</p>
</blockquote>
<p>设置分发策略：<a href="https://nodejs.org/api/cluster.html#cluster_cluster_schedulingpolicy" target="_blank" rel="external">cluster.schedulingPolicy</a><br>最后看一下PM2中关于<a href="https://github.com/Unitech/pm2/blob/master/lib/God/ClusterMode.js" target="_blank" rel="external">cluster_mode的源码</a>，<br>可以得出结论：想省事，直接设置 <code>NODE_CLUSTER_SCHED_POLICY</code> 环境变量就够了。</p>
<h2 id="Buffer"><a href="#Buffer" class="headerlink" title="Buffer"></a>Buffer</h2><ul>
<li><a href="https://nodejs.org/dist/v0.12.7/docs/api/buffer.html#buffer_class_slowbuffer" target="_blank" rel="external">文档v0.12</a></li>
<li><a href="https://nodejs.org/api/buffer.html#buffer_class_slowbuffer" target="_blank" rel="external">文档v5.1</a></li>
<li>相关模块：所有涉及二进制处理的模块</li>
<li>应用场景：二进制处理、协议解析、字符编码转换</li>
<li>关注原因：新增3个ES6数组方法，以及迭代器文档</li>
</ul>
<blockquote>
<p><a href="https://nodejs.org/api/buffer.html#buffer_buffer_entries" target="_blank" rel="external">buffer.entries()</a><br><a href="https://nodejs.org/api/buffer.html#buffer_buffer_keys" target="_blank" rel="external">buffer.keys()</a><br><a href="https://nodejs.org/api/buffer.html#buffer_buffer_values" target="_blank" rel="external">buffer.values()</a><br><a href="https://nodejs.org/api/buffer.html#buffer_es6_iteration" target="_blank" rel="external">ES6 iteration</a></p>
</blockquote>
<p>另外需要注意的是，Buffer的是实现在 <strong>v0.8 =&gt; v0.10</strong> 的升级中也发生过变化，所以在网上搜索 Buffer 相关文档的时候一定要留意nodejs的版本：</p>
<blockquote>
<p>Creating a typed array from a Buffer works with the following caveats:</p>
<blockquote>
<ol>
<li>The buffer’s memory is copied, not shared.</li>
<li>The buffer’s memory is interpreted as an array, not a byte array. That is, new Uint32Array(new Buffer([1,2,3,4])) creates a 4-element Uint32Array with elements [1,2,3,4], not a Uint32Array with a single element [0x1020304] or[0x4030201].<br>NOTE: Node.js v0.8 simply retained a reference to the buffer in array.buffer instead of cloning it.</li>
</ol>
</blockquote>
<p>While more efficient, it introduces subtle incompatibilities with the typed arrays specification. ArrayBuffer#slice() makes a copy of the slice while Buffer#slice()creates a view.</p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: false,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
    


  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/">&lt; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
    </nav>
  

</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2017 crzidea.com
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的静态博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减双栏 Hexo 博客主题">Yelee</a> by MOxFIVE
        </div>
    </div>
    <div class="visit">
      <span id="busuanzi_container_site_pv" style='display:none'>
        <span id="site-visit" >本站到访数: 
        <span id="busuanzi_value_site_uv"></span>
        </span>
      </span>
      <span id="busuanzi_container_page_pv" style='display:none'>
        <span id="page-visit">, 本页阅读量: 
        <span id="busuanzi_value_page_pv"></span>
        </span>
      </span>
    </div>
  </div>
</footer>
    </div>
    
	<script>
		var yiliaConfig = {
			fancybox: false,
			mathjax: true,
			animate: false,
			isHome: true,
			isPost: false,
			isArchive: false,
			isTag: false,
			isCategory: false,
			open_in_new: false
		}
	</script>


<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

  <style>
    body {
      background: lightgray;
    }
    #container .left-col {
      background: white;
    }
    .article-inner {
      background: white;
    }
    .post-nav-button {
      background: #ececec;
    }
    #header .header-nav .social #GitHub {
      background-color: #bfd3ec;
    }
  </style>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-81807912-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
<a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
<a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>


<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  </div>

</body>
</html>
