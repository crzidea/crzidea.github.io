<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Crzidea</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Crzidea">
<meta property="og:url" content="https://crzidea.com/index.html">
<meta property="og:site_name" content="Crzidea">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Crzidea">
  
    <link rel="alternative" href="/atom.xml" title="Crzidea" type="application/atom+xml">
  
  
  <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
</head>

<body>

  <!-- 分享时显示的图片 -->
  <div style='display:none;'>
      <img src="/favicon.png" />
  </div>

  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/img/avatar.png" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">crzidea.com</a></h1>
		</hgroup>

		
		


		
			<div id="switch-btn" class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>

				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
					</ul>
				</div>
			</div>
		

		<div id="switch-area" class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives/">列表</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<ul class="social">
							
								<li id="Email"><a class="Email" target="_blank" href="mailto:micro-tech@foxmail.com" title="Email"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/crzidea" title="GitHub"></a></li>
					        
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/crzidea" title="新浪微博"></a></li>
					        
								<li id="QQ"><a class="QQ" target="_blank" href="http://wpa.qq.com/msgrd?v=3&uin=133683737&site=qq&menu=yes" title="QQ"></a></li>
					        
						</ul>
					</nav>
				</section>

				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Bash/" style="font-size: 10px;">Bash</a> <a href="/tags/FEDAY/" style="font-size: 10px;">FEDAY</a> <a href="/tags/RESTful/" style="font-size: 10px;">RESTful</a> <a href="/tags/React/" style="font-size: 10px;">React</a> <a href="/tags/WSL/" style="font-size: 10px;">WSL</a> <a href="/tags/Windows/" style="font-size: 10px;">Windows</a> <a href="/tags/array/" style="font-size: 10px;">array</a> <a href="/tags/build/" style="font-size: 10px;">build</a> <a href="/tags/database/" style="font-size: 10px;">database</a> <a href="/tags/date/" style="font-size: 10px;">date</a> <a href="/tags/deploy/" style="font-size: 10px;">deploy</a> <a href="/tags/distribution/" style="font-size: 10px;">distribution</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/docker-registry-mirror/" style="font-size: 10px;">docker registry mirror</a> <a href="/tags/full-stack/" style="font-size: 10px;">full stack</a> <a href="/tags/gamepad/" style="font-size: 10px;">gamepad</a> <a href="/tags/gopigo/" style="font-size: 10px;">gopigo</a> <a href="/tags/https/" style="font-size: 10px;">https</a> <a href="/tags/javascript/" style="font-size: 20px;">javascript</a> <a href="/tags/koa/" style="font-size: 10px;">koa</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/memory-leak/" style="font-size: 10px;">memory leak</a> <a href="/tags/micro-service/" style="font-size: 10px;">micro service</a> <a href="/tags/mintty/" style="font-size: 10px;">mintty</a> <a href="/tags/nodejs/" style="font-size: 20px;">nodejs</a> <a href="/tags/ops/" style="font-size: 10px;">ops</a> <a href="/tags/performace/" style="font-size: 10px;">performace</a> <a href="/tags/range/" style="font-size: 10px;">range</a> <a href="/tags/raspberry-pi/" style="font-size: 10px;">raspberry pi</a> <a href="/tags/replace/" style="font-size: 10px;">replace</a> <a href="/tags/replication/" style="font-size: 10px;">replication</a> <a href="/tags/rethinkdb/" style="font-size: 10px;">rethinkdb</a> <a href="/tags/scaling/" style="font-size: 10px;">scaling</a> <a href="/tags/sed/" style="font-size: 10px;">sed</a> <a href="/tags/sequelize/" style="font-size: 10px;">sequelize</a> <a href="/tags/sharding/" style="font-size: 10px;">sharding</a> <a href="/tags/share/" style="font-size: 10px;">share</a> <a href="/tags/shell/" style="font-size: 10px;">shell</a> <a href="/tags/shuffle/" style="font-size: 10px;">shuffle</a> <a href="/tags/sort/" style="font-size: 10px;">sort</a> <a href="/tags/systemd/" style="font-size: 10px;">systemd</a> <a href="/tags/tmux/" style="font-size: 10px;">tmux</a> <a href="/tags/user-group/" style="font-size: 10px;">user group</a> <a href="/tags/velocity/" style="font-size: 10px;">velocity</a> <a href="/tags/web/" style="font-size: 10px;">web</a> <a href="/tags/wsltty/" style="font-size: 10px;">wsltty</a> <a href="/tags/企业平台/" style="font-size: 10px;">企业平台</a> <a href="/tags/前端/" style="font-size: 10px;">前端</a>
					</div>
				</section>
				

				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https://github.com/">GitHub</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://tech.meituan.com/">美团点评技术团队</a>
			        
			        </div>
				</section>
				

				
			</div>
		</div>
	</header>
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">crzidea.com</a></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<a href="/" class="profilepic">
                
                <img src="/img/avatar.png" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
                
			</a>
			<hgroup>
			  <h1 class="header-author"><a href="/" title="回到主页">crzidea.com</a></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives/">列表</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
						<ul class="social">
							
								<li id="Email"><a class="Email" target="_blank" href="mailto:micro-tech@foxmail.com" title="Email"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/crzidea" title="GitHub"></a></li>
					        
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/crzidea" title="新浪微博"></a></li>
					        
								<li id="QQ"><a class="QQ" target="_blank" href="http://wpa.qq.com/msgrd?v=3&uin=133683737&site=qq&menu=yes" title="QQ"></a></li>
					        
						</ul>
			</nav>
		</header>
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-velocity-2016-notes" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/12/05/velocity-2016-notes/" class="article-date">
  	<time datetime="2016-12-05T03:09:48.000Z" itemprop="datePublished">2016-12-05</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/05/velocity-2016-notes/">Velocity 2016 参会笔记</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="大规模系统平衡性能最佳实践和弹性工程"><a href="#大规模系统平衡性能最佳实践和弹性工程" class="headerlink" title="大规模系统平衡性能最佳实践和弹性工程"></a>大规模系统平衡性能最佳实践和弹性工程</h2><ul>
<li>Fire TV 的遥控器导航用例很有意思。但是太复杂了，但是值得思考。改变遥控器的输入方式，好像可以更简单的解决问题。</li>
<li>有能跑 JavaScript 的电视棒了，是个好消息。</li>
<li>并没有开源。但是有个 starter 项目仓库。</li>
<li>讲师的中英文交叉的很6。</li>
</ul>
<h2 id="Web-组件介绍"><a href="#Web-组件介绍" class="headerlink" title="Web 组件介绍"></a>Web 组件介绍</h2><ul>
<li>Web is always fragmented。</li>
<li>ES6 class extends HTMLElement + Shadow DOM 实现 Web Component 很有意思。</li>
<li>attributeChangeCallback 可以实现自定义属性改变时的行为。</li>
<li>Template tag 可以用于代替 JSX。</li>
<li><a href="https://webcomponents.org" target="_blank" rel="external">https://webcomponents.org</a> 有 polyfill 支持</li>
<li>明天会讲 Polymer at YouTube。</li>
</ul>
<h2 id="零点之战——阿里双11技术架构演进之路"><a href="#零点之战——阿里双11技术架构演进之路" class="headerlink" title="零点之战——阿里双11技术架构演进之路"></a>零点之战——阿里双11技术架构演进之路</h2><ul>
<li>很虚，PPT 做的很烂，字太多，图里面的字很小，画的也很难看。一直强调我们业务很复杂、用户量很大、流量很大，数据库怎么做一致性都没提。</li>
<li>保障服务集群在区域内可以独立完成。（只有买家的业务会在自己的区域内独立完成。）</li>
<li>服务集群可以快速复制。</li>
<li>流量链条压测工具。</li>
<li>阿里云降低双十一机器成本。</li>
<li>处理不了的流量主动拒绝服务。</li>
<li>动态设置任务分配不均的实例的权重。</li>
<li>不要再线上使用没有测试过的预案。</li>
</ul>
<h2 id="OceanBase：蚂蚁双十一背后的关系数据库"><a href="#OceanBase：蚂蚁双十一背后的关系数据库" class="headerlink" title="OceanBase：蚂蚁双十一背后的关系数据库"></a>OceanBase：蚂蚁双十一背后的关系数据库</h2><ul>
<li>4 年落地，双十一全部使用 OceanBase。</li>
<li>满足强一致性。</li>
<li>分布式投票，Paxos协议强同步。但机房至少一个 raplication 做 backup。</li>
<li>模拟断电断网。</li>
<li>数据迁移，灰度引流，留好后路，随时回滚。</li>
<li>查了一下，目前还没有开源。</li>
<li>完全兼容 MySQL，优化器向 Oracle 学习。</li>
<li>支持单个实例 10w 连接数。</li>
<li>查询过程打断点，执行过程中可以取消执行，防止大查询占用过度资源。</li>
</ul>
<h2 id="滴滴弹性在线存储平台"><a href="#滴滴弹性在线存储平台" class="headerlink" title="滴滴弹性在线存储平台"></a>滴滴弹性在线存储平台</h2><ul>
<li>听起来很不靠谱，没有亮点，不知道为什么会做这个东西。一上来就是 redis、hbase、mongodb 都满足不了我们的需求，所以我们要自研。另一个造轮子的理由是，我们无法修改上游的代码。而且存储引擎是基于 RocksDB 和 Redis 的。尤其是数据同步的方案，竟然用 PPTP 的时间戳作为参考，呵呵哒。</li>
<li>核心在于实现了一个可以伸缩的 Slot/Region 的路由表。</li>
</ul>
<h2 id="58-到家微服务架构实践"><a href="#58-到家微服务架构实践" class="headerlink" title="58 到家微服务架构实践"></a>58 到家微服务架构实践</h2><ul>
<li>比较水，其他厅也没有有价值的主题了，随便听一下吧。</li>
</ul>
<h2 id="DT时代的业务实时监控之道"><a href="#DT时代的业务实时监控之道" class="headerlink" title="DT时代的业务实时监控之道"></a>DT时代的业务实时监控之道</h2><ul>
<li>和我们的业务比较像。</li>
<li>计算任务可以在前端编排。</li>
<li>存储用的 hbase，用法很想 OpenTSDB。</li>
<li>通过接口支持自定义查询。</li>
<li>支持自定义可视化。</li>
<li>只支持 5 个维度，但是对于维度的值不限制数量，但是遇到维度爆炸的情况会截断展开的量。</li>
<li>没有考虑维度爆炸造成的存储资源浪费的问题。</li>
<li>Hbase 热点的问题，通过把 维度 放在 timestamp 之前解决。</li>
<li>整体来看，整个的产品完成度非常高，我们需要一段时间才能追赶上。</li>
<li>思考：需要做排名的指标，用我之前提出的记录用户访问习惯的思路可能会稍微做一下修改。</li>
</ul>
<h2 id="主题发言-阿里应用运维体系演变"><a href="#主题发言-阿里应用运维体系演变" class="headerlink" title="主题发言 阿里应用运维体系演变"></a>主题发言 阿里应用运维体系演变</h2><ul>
<li>脚本化 =&gt; 工具化 =&gt; DevOPS =&gt; 自动化</li>
<li>工具化<ul>
<li>工具/运维团队 =&gt; 合并各工具团队 =&gt; 工具团队同时兼 OPS 工作。</li>
<li>工具化遇到的问题：<ul>
<li>推进落地难，思想转变，时间保障。</li>
<li>有工具，但是工具的质量不高，运维的幸福感并没有明显提升。</li>
<li>标准化，和国外差距比较大，刚开始做不好，就要化很多年时间去填补。</li>
</ul>
</li>
</ul>
</li>
<li>DevOPS<ul>
<li>将运维团队交还给研发团队。之前将运维的组织架构统一到一起，现在拆开。</li>
<li>借助 Docker。</li>
</ul>
</li>
<li>自动化<ul>
<li>有工具但是需要人点，需要巨大的碎片化时间投入。</li>
<li>无人值守比较难做。以发布过程为例，没有一个判断发布成功的统一条件。</li>
</ul>
</li>
<li>智能化<ul>
<li>还没开始做。</li>
<li>说要通过机器学习判断特征，这个比较扯，比如 1000 个应用，999 个被下线了，机器学习是不是就自动下线最后一个应用呢？要是最后一个应用不能被下线怎么办？</li>
</ul>
</li>
</ul>
<h2 id="主题发言-测量服务的可运维性-Measure-the-operability-of-your-service"><a href="#主题发言-测量服务的可运维性-Measure-the-operability-of-your-service" class="headerlink" title="主题发言 测量服务的可运维性 (Measure the operability of your service)"></a>主题发言 测量服务的可运维性 (Measure the operability of your service)</h2><ul>
<li>讲师的开场介绍好像是在被面试一样。</li>
<li>讲师的表达不太好。</li>
</ul>
<h2 id="Swarm优化：从单实例管理-1000-nodes-到-30000-nodes"><a href="#Swarm优化：从单实例管理-1000-nodes-到-30000-nodes" class="headerlink" title="Swarm优化：从单实例管理 1000 nodes 到 30000 nodes"></a>Swarm优化：从单实例管理 1000 nodes 到 30000 nodes</h2><ul>
<li>选择 Swarm 而不是其他方案的原因是因为对 docker 本身的协议更熟悉，方便深度定制。</li>
<li>提到阿里采用的大部分开源软件都是经过深度定制的。</li>
<li>问题：是否支持 airplane 或 busybox 之类的镜像。</li>
<li>遇到的性能问题：<ul>
<li>节点多，线程太多，Swarm 进程直接崩溃。</li>
<li>TCP 连接泄露。</li>
</ul>
</li>
<li>实例太多，需要引入更多管理系统。</li>
<li>（对 golang 语言相关的不感兴趣，跳过这部分细节了。）</li>
<li>Swarm 线程最大线程数默认被限制在 50k。<ul>
<li>官方的解释是网络 IO 会创建很多线程。</li>
<li>真正的原因是使用 conn.File() 将连接设置为了 block 模式。<pre><code>问题：查了一下已经被阿里的人提交 PR 并 merge 了。我的问题是，setTCPUserTimeout() 是 keepalive 还是应用层的心跳？删掉之后会有什么影响？如果是中间使用了代理会怎么样呢？
回答：删掉之后会造成没有应用层心跳机制，要两个小时才能检测到另一端死掉了。Swarm 的协议并没有提供可以穿透代理的端到端的心跳机制。阿里内部的跨级房 Swarm 通信中间没有网管或代理，所以不会遇到 TCP 的心跳不能穿透代理的问题。
</code></pre></li>
</ul>
</li>
<li>CPU消耗特别大，有很多低效率的算法造成的问题。</li>
<li>问题：查了一下已经被阿里的人提交 PR 并 merge 了。我的问题是，setTCPUserTimeout() 是 keepalive 还是应用层的心跳？删掉之后会有什么影响？如果是中间使用了代理会怎么样呢？<pre><code>回答：删掉之后会造成没有应用层心跳机制，要两个小时才能检测到另一端死掉了。Swarm 的协议并没有提供可以穿透代理的端到端的心跳机制。阿里内部的跨级房 Swarm 通信中间没有网管或代理，所以不会遇到 TCP 的心跳不能穿透代理的问题。
</code></pre></li>
<li>问题：阿里内部的 docker 容器可以支持所有的镜像吗？比如 alpine。<pre><code>回答并不可以，只能使用我们自己维护的镜像（有点儿像我们的 cargo）。而且只有 readhat 系的，想用 ubuntu 是不可能的（还不如 cargo）。社区的应用基本上没法用。
</code></pre></li>
</ul>
<h2 id="OWL-分布式开源监控最佳实践"><a href="#OWL-分布式开源监控最佳实践" class="headerlink" title="OWL 分布式开源监控最佳实践"></a>OWL 分布式开源监控最佳实践</h2><ul>
<li>完全是来广告的。和我们的量级和功能相比，太小了，没什么有价值的信息。</li>
</ul>
<h2 id="网易蜂巢基于-kubernetes-的公有云运维实践"><a href="#网易蜂巢基于-kubernetes-的公有云运维实践" class="headerlink" title="网易蜂巢基于 kubernetes 的公有云运维实践"></a>网易蜂巢基于 kubernetes 的公有云运维实践</h2><ul>
<li>作者的背景很靠谱，有很多容器化、虚拟化方案的经验。</li>
<li>计算/网络/存储虚拟化</li>
<li>从虚拟机到容器<ul>
<li>以资源为核心 =&gt; 以应用为核心</li>
<li>有状态的容器：保留内存和硬盘可写能力</li>
<li>容器跨主机互联</li>
<li>云盘</li>
</ul>
</li>
<li>一板斧：去状态、可扩展（都已经喊得烂了，不记了）</li>
<li>二板斧：容器化、可编排<ul>
<li>Kuber 系技术栈实现快速编排无状态的应用，相当于分布式的 docker-compose，</li>
</ul>
</li>
<li>三板斧：DevOPS、可迭代<ul>
<li>主要讲的多个环境自动选择配置选项。基本上靠 CI、CD、kuber 系的 compose 功能实现。</li>
</ul>
</li>
<li>私有云到公有云<ul>
<li>容器的安全<pre><code>不同租户之间不共享虚拟机。
</code></pre></li>
<li>容器的启动速度<pre><code>第一次启动比较慢，后面会比较快。
</code></pre></li>
<li>容器的规模<pre><code>扩展到了 15k 个 kuber 节点。
</code></pre></li>
<li>容器的租户隔离<pre><code>不同租户之间不共享虚拟机。
</code></pre></li>
</ul>
</li>
<li>编排优化<ul>
<li>支持多用户</li>
<li>调度性能用户，默认只支持单个串行队列</li>
<li>提高集群扩展性，通过拆分 etcd 集群实现</li>
</ul>
</li>
<li>虚拟机启动优化：提前分配 IP</li>
<li>提供内部镜像仓库，提升下载镜像的速度</li>
<li>整个蜂巢全部采用没有修改过的开源软件（这一点非常赞！好多公司都做不到啊！）</li>
</ul>
<h2 id="阿里巴巴-Aliware-十年微服务架构演进历程中的挑战与实践"><a href="#阿里巴巴-Aliware-十年微服务架构演进历程中的挑战与实践" class="headerlink" title="阿里巴巴 Aliware 十年微服务架构演进历程中的挑战与实践"></a>阿里巴巴 Aliware 十年微服务架构演进历程中的挑战与实践</h2><ul>
<li>上百个人维护一个核心工程<ul>
<li>源代码冲突严重</li>
<li>协同成本极高</li>
</ul>
</li>
<li>问题：工程化的方案，为什么没有采用 google、facebook 整个公司的代码放在一个仓库里的做法？放在一个仓库里还可以共享很多已经实现的逻辑看起来效率更高。</li>
<li>错误难以隔离</li>
<li>讲师：能写 if 就不会去重构了（谁要敢这么说，以后估计都不会找到工作了）。</li>
<li>数据库能力达到上限<ul>
<li>连接数捉襟见肘</li>
<li>单机 IOPS 达到瓶颈</li>
</ul>
</li>
<li>数据库容量日趋饱和</li>
<li>长期高负荷运转，接近崩溃边缘</li>
<li>数据孤岛<ul>
<li>数据隔离</li>
<li>不一致</li>
<li>无法复用</li>
</ul>
</li>
<li>无法进行全局数据分析</li>
<li>中间件 / 基础服务<ul>
<li>RPC</li>
<li>消息队列</li>
<li>配置中心</li>
<li>监控（一直在讲 Java 系相关的内容，没兴趣）</li>
<li>调用链路分析</li>
<li>容量规划<ul>
<li>制造流量 =&gt; 压测单机性能 =&gt; 设定运行水位 =&gt; 计算机器使用量 =&gt; 机器上下线</li>
<li>每天自动运行压测 =&gt; 部署前进行压测。</li>
<li>亮点：<pre><code>- 使用线上流量进行压测，和 tcpcopy / goreplay 类似。
- 根据运行水位自动伸缩，方案的完成度比较高。
</code></pre></li>
<li>思考：性能平台达到可以扩张的时候，可以提供在线压测平台。</li>
</ul>
</li>
<li>限流降级</li>
</ul>
</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/database/">database</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/micro-service/">micro service</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ops/">ops</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/performace/">performace</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/velocity/">velocity</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/">web</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: false,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
    


  
    <article id="post-start-using-windows-subsystem-for-linux" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/11/30/start-using-windows-subsystem-for-linux/" class="article-date">
  	<time datetime="2016-11-30T03:00:00.000Z" itemprop="datePublished">2016-11-30</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/30/start-using-windows-subsystem-for-linux/">浅尝 Windows Subsystem for Linux</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h2 id="安装-卸载-重置"><a href="#安装-卸载-重置" class="headerlink" title="安装/卸载/重置"></a>安装/卸载/重置</h2><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><ul>
<li>准备一台安装了 Windows 10 的 PC，并将系统升级到最新版本。</li>
<li>（可选，但是建议）安装 Fast Ring 的 Insider Preview 版本更新。</li>
<li>在<code>Update &amp; security</code>配置中，开启<code>Developer mode</code>。</li>
<li>在<code>Turn Windows features on or off</code>中，开启<code>Windows Subsystem for Linux (Beta)</code>。</li>
<li>运行<code>bash</code>命令。</li>
</ul>
<h3 id="其他操作"><a href="#其他操作" class="headerlink" title="其他操作"></a>其他操作</h3><p>在 <strong>powershell</strong> 或者 <strong>cmd</strong> 中执行下面的命令，可以查看 安装/卸载/重置 WSL 相关的参数。</p>
<figure class="highlight ps"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lxrun /?</div></pre></td></tr></table></figure>
<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><table>
<thead>
<tr>
<th>WSL 路径</th>
<th>Windows 路径</th>
</tr>
</thead>
<tbody>
<tr>
<td> /</td>
<td>%localappdata%\Lxss\rootfs</td>
</tr>
<tr>
<td> /mnt/c</td>
<td>C:\</td>
</tr>
</tbody>
</table>
<h2 id="新建文件默认权限-umask"><a href="#新建文件默认权限-umask" class="headerlink" title="新建文件默认权限 - umask"></a>新建文件默认权限 - umask</h2><p>目前 WSL 默认的新建文件默认权限存在问题。例如运行下面的命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">touch <span class="built_in">test</span> &amp;&amp; ll <span class="built_in">test</span></div></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-rw-rw-rw-<span class="number"> 1 </span>crzidea crzidea<span class="number"> 0 </span>Nov<span class="number"> 30 </span>11:45 test</div></pre></td></tr></table></figure>
<p>可以看到 group 和 other 用户都默认拥有了写权限。这是因为 umask 没有被正确设置：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">umask</span> <span class="comment"># 输出结果为 0000</span></div></pre></td></tr></table></figure>
<p>要解决这个问题，需要在 bashrc 中手动加入下面一行命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">umask</span> 022</div></pre></td></tr></table></figure>
<p>重新打开终端后，重新执行上面的测试：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rm <span class="built_in">test</span> &amp;&amp; touch <span class="built_in">test</span> &amp;&amp; ll <span class="built_in">test</span></div></pre></td></tr></table></figure>
<p>可以看到文件权限可以被正确设置了：</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-rw-r--r--<span class="number"> 1 </span>crzidea crzidea<span class="number"> 0 </span>Nov<span class="number"> 30 </span>11:45 test</div></pre></td></tr></table></figure>
<p>另外，通过 <code>/mnt/</code> 路径访问文件时，文件权限大部分为 <code>rwx</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ll /mnt/c</div></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">drwxrwxrwx<span class="number"> 0 </span>root root     <span class="number"> 0 </span>Nov<span class="number"> 30 </span>11:29 cygwin64</div><div class="line">-????????? ? ?    ?         ?            ? hiberfil.sys</div><div class="line">drwxrwxrwx<span class="number"> 0 </span>root root     <span class="number"> 0 </span>Nov<span class="number"> 19 </span>13:53 Intel</div><div class="line">drwxrwxrwx<span class="number"> 0 </span>root root     <span class="number"> 0 </span>Nov<span class="number"> 30 </span>12:40 OneDriveTemp</div><div class="line">-????????? ? ?    ?         ?            ? pagefile.sys</div><div class="line">d---------<span class="number"> 0 </span>root root     <span class="number"> 0 </span>Nov<span class="number"> 18 </span>21:27 PerfLogs</div><div class="line">drwxrwxrwx<span class="number"> 0 </span>root root     <span class="number"> 0 </span>Nov<span class="number"> 19 </span>14:33 ProgramData</div><div class="line">dr-xr-xr-x<span class="number"> 0 </span>root root     <span class="number"> 0 </span>Nov<span class="number"> 19 </span>13:53 Program Files</div><div class="line">dr-xr-xr-x<span class="number"> 0 </span>root root     <span class="number"> 0 </span>Nov<span class="number"> 19 </span>13:53 Program Files (x86)</div><div class="line">dr-xr-xr-x<span class="number"> 0 </span>root root     <span class="number"> 0 </span>Nov<span class="number"> 19 </span>13:55 Recovery</div><div class="line">drwxrwxrwx<span class="number"> 0 </span>root root     <span class="number"> 0 </span>Nov<span class="number"> 19 </span>14:47 $RECYCLE.BIN</div><div class="line">-????????? ? ?    ?         ?            ? swapfile.sys</div><div class="line">drwxrwxrwx<span class="number"> 0 </span>root root     <span class="number"> 0 </span>Nov<span class="number"> 18 </span>21:33 $SysReset</div><div class="line">d---------<span class="number"> 0 </span>root root     <span class="number"> 0 </span>Nov<span class="number"> 30 </span>10:39 System Volume Information</div><div class="line">dr-xr-xr-x<span class="number"> 0 </span>root root     <span class="number"> 0 </span>Nov<span class="number"> 19 </span>14:48 Users</div><div class="line">dr-xr-xr-x<span class="number"> 0 </span>root root     <span class="number"> 0 </span>Nov<span class="number"> 30 </span>10:45 Windows</div><div class="line">dr-xr-xr-x<span class="number"> 0 </span>root root     <span class="number"> 0 </span>Nov<span class="number"> 30 </span>12:33 $WINDOWS.~BT</div><div class="line">drwxrwxrwx<span class="number"> 0 </span>root root     <span class="number"> 0 </span>Nov<span class="number"> 19 </span>19:47 Windows.old</div></pre></td></tr></table></figure>
<h2 id="tmux-相关"><a href="#tmux-相关" class="headerlink" title="tmux 相关"></a>tmux 相关</h2><p>目前 WSL 可以支持绝大多数的 tmux 操作，这也是 WSL 发布时拿出来秀肌肉的亮点。但是测试中发现使用快捷键（默认<code>prefix + &quot;</code>）对 tmux 分屏时，无法保留当前的路径。在终端中运行<code>tmux split</code>不会有这个问题。</p>
<h2 id="文件系统事件-inotify"><a href="#文件系统事件-inotify" class="headerlink" title="文件系统事件 - inotify"></a>文件系统事件 - inotify</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt install -y inotify-tools</div></pre></td></tr></table></figure>
<p>WSL 的早期版本无法使用 inotify 工具，也无法获取文件变动的事件。但是目前 Insider Preview 版本已经实现了功能，这些这也是建议用户升级到 Insider Preview Fast Ring 的原因之一。</p>
<p>另外由于 WSL 文件系统的特殊性，需要注意：</p>
<ul>
<li>在 bash 环境下修改 /mnt/c 中的文件，也可使用这些事件。</li>
<li>在 Windows 环境中修改文件，不会触发事件。</li>
</ul>
<h2 id="使用-bash-启动-Windows-应用程序"><a href="#使用-bash-启动-Windows-应用程序" class="headerlink" title="使用 bash 启动 Windows 应用程序"></a>使用 bash 启动 Windows 应用程序</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/mnt/c/Windows/System32</div><div class="line">notepad.exe</div></pre></td></tr></table></figure>
<p><strong>注意</strong>：被调用的 Windows 应用程序可能无法正确识别传入的路径参数，例如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">explorer.exe / <span class="comment"># 无法正确识别 `/` 路径</span></div></pre></td></tr></table></figure>
<h2 id="使用-Windows-应用程序监控-WSL-进程"><a href="#使用-Windows-应用程序监控-WSL-进程" class="headerlink" title="使用 Windows 应用程序监控 WSL 进程"></a>使用 Windows 应用程序监控 WSL 进程</h2><p>通过 WSL 启动的进程可以在 Windows 中访问到。例如在<code>powershell</code>中执行：</p>
<figure class="highlight ps"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">get-process</span></div></pre></td></tr></table></figure>
<p>可以从输出列表中查找到从 WSL 启动的 bash、ssh、node 之类的进程。</p>
<h2 id="中文字符"><a href="#中文字符" class="headerlink" title="中文字符"></a>中文字符</h2><p>默认的 bash 命令行程序可能会无法正确显示中文，建议使用 mintty/wsltty 作为日常使用的终端应用程序。</p>
<h2 id="个性化终端"><a href="#个性化终端" class="headerlink" title="个性化终端"></a>个性化终端</h2><h3 id="bash-exe"><a href="#bash-exe" class="headerlink" title="bash.exe"></a>bash.exe</h3><p>bash.exe 实际上是一个<code>Windows Console Application</code>，终端的样式（颜色、字体、光标）可以通过注册表修改，但是可以修改的项目有限。</p>
<h3 id="mintty"><a href="#mintty" class="headerlink" title="mintty"></a>mintty</h3><p>如果觉得默认的 bash.exe 终端太挫了，可以用 mintty + wslbridge 的组合代替。</p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>mintty 作者建了一个 wsltty 的项目专门用于发布用于 WSL 的终端。但是亲测后发现 Windows 升级之后，之前发布的编译好的终端已经无法运行了。所以需要自己动手将下面的几个玩具组合起来。</p>
<ul>
<li>mintty 需要从 <a href="cygwin64">cygwin64</a> 提取</li>
<li><a href="https://github.com/mintty/wsltty" target="_blank" rel="external">wsltty</a></li>
<li><a href="https://github.com/rprichard/wslbridge/releases" target="_blank" rel="external">wslbridge</a></li>
</ul>
<p>将所有文件都解压到<code>C:\cygwin64\bin</code>中，运行<code>install.bat</code>即可。</p>
<h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>下载<a href="https://github.com/crzidea/confbook/blob/master/.minttyrc" target="_blank" rel="external">已经配置好的 Monokai 样式文件</a>放入下面的目录，重新打开 mintty 即可：</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">%localappdata%\wsltty\home\%username%\</div></pre></td></tr></table></figure>
<h2 id="日常开发"><a href="#日常开发" class="headerlink" title="日常开发"></a>日常开发</h2><p>这篇博客其实就是在 WSL 的 vim 中编辑的，并且使用 node 创建了一个 web 服务器。所以使用 WSL 应对日常的开发，应该是没有问题的。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://msdn.microsoft.com/en-us/commandline/wsl/release_notes" target="_blank" rel="external">Bash on Ubuntu on Windows - Release Notes</a></li>
<li><a href="https://github.com/Microsoft/BashOnWindows/issues" target="_blank" rel="external">Track or report an issue</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Bash/">Bash</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WSL/">WSL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Windows/">Windows</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mintty/">mintty</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tmux/">tmux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wsltty/">wsltty</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: false,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
    


  
    <article id="post-koa-restql" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/12/koa-restql/" class="article-date">
  	<time datetime="2016-08-12T03:26:00.000Z" itemprop="datePublished">2016-08-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/12/koa-restql/">RestQL：现代化的 API 开发方式</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <blockquote>
<p>本文已在<a href="http://tech.meituan.com/koa-restql.html" target="_blank" rel="external">美团点评技术博客</a>发表，谢绝转载！</p>
<p>koa-restql 已经在 <a href="https://github.com/Meituan-Dianping/koa-restql" target="_blank" rel="external">github</a> 开源并在 <a href="https://www.npmjs.com/package/koa-restql" target="_blank" rel="external">npm</a> 发布。感兴趣的同学可以前往围观一下。欢迎 Pull Request，同时热烈欢迎 Star。</p>
</blockquote>
<p>在现代的业务系统中，后端开发工作基本上可以被拆分为三项：</p>
<ul>
<li><strong>接口鉴权</strong>。例如拍段是不是当前系统的用户，以及该用户是否有权限访问接口。</li>
<li><strong>与其他系统的交互</strong>。例如调用第三方的服务，或内部搭建的其他服务。</li>
<li><strong>数据操作</strong>。基本上所有需要持久化存储的系统都会在这项工作上耗费大量时间。</li>
</ul>
<p>本文将介绍如何利用 RestQL 来非常有效地减少「数据操作」相关的工作量。</p>
<h2 id="现状与挑战"><a href="#现状与挑战" class="headerlink" title="现状与挑战"></a>现状与挑战</h2><p>我们先来做个假设。</p>
<ul>
<li>假设系统中有 60 张表，每张表对应的接口都要有四种 CRUD 的 API。那么就需要后端工程师写<code>60 * 4 = 240</code>个API。</li>
<li>假设上述 60 张表中，40 张表存的是资源类的数据，其余 20 张表为关系类的数据，也就是说每张表和 20 张表都要进行关联，每个关联也需要四种 CRUD 操作，那么又要增加<code>40 * 20 * 4 = 3200</code>个API。</li>
</ul>
<p>所以在上述假设场景中，后端工程师要编写 3200 + 240 = 3440 个 API。而且这还不是全部。假如后端代码需要 100% 的测试覆盖，那么工程师们就要写至少 3440 个测试！</p>
<blockquote>
<p>60 张表 = 3440 个 API + 3440 个单元测试</p>
</blockquote>
<p>众所周知，数据操作 API 的实现过程基本上是重复的，有的同学甚至认为这是低端的，体现不出工程师价值的工作，纯粹的「体力活」。但是却没有一个能真正解放生产力的方案。</p>
<h2 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h2><p>尽管我们把数据库抽象成了「关系型」数据库，把操作数据的命令抽象成了 SQL ，同时我们也有了 MySQL 客户端，甚至是 sequelize 这种非常方便的库，也有「RESTful」API 命名规则，但是接口的实现从来都是需要工程师们自己用手敲出来的。</p>
<blockquote>
<p>如果说我看得比别人远，那是因为我站在巨人的肩膀上。</p>
</blockquote>
<p>所以我们在现有的技术基础上再抽象，把已有的东西重新组合起来，拼装成一个新的工具，帮助工程师从「体力活」中解脱出来，解放生产力。</p>
<h3 id="什么样的工具"><a href="#什么样的工具" class="headerlink" title="什么样的工具"></a>什么样的工具</h3><p>最开始的时候，我们最先需要明确的问题就是：「我们需要什么样的工具？」或者说「这种工具要帮我们解决什么问题？」。</p>
<p>实际上我们从刚才的假设中，已经可以得出结论：我们希望有一个工具可以让工程师免于编写数据操作 API，<strong><em>把数据库操作直接映射到 HTTP RESTful API 上</em></strong>。</p>
<h2 id="调用方式"><a href="#调用方式" class="headerlink" title="调用方式"></a>调用方式</h2><h3 id="如何请求"><a href="#如何请求" class="headerlink" title="如何请求"></a>如何请求</h3><p>为了解释「如何请求」，我们先从一些公认的规则出发，举一个例子，然后再从例子中抽象出一些规则。</p>
<p><strong>注意</strong>：为了更便于理解，我们把所有的命名从客户端一直穿透到数据库，所以请不要纠结于我们在定义一个 API 时名词单复数的问题。</p>
<h4 id="基本用例"><a href="#基本用例" class="headerlink" title="基本用例"></a>基本用例</h4><p>几乎所有的系统都会有一个用户表（user）。根据 RESTful 规则的约定，我们应该把访问 user 表的 API 路径定义为 <code>/user</code>，并把 CRUD 的访问方法映射到 HTTP 协议中的四种方法：<code>GET</code>、<code>POST</code>、<code>PUT</code>、<code>DELETE</code>。</p>
<p>比如：</p>
<ul>
<li><code>GET /user</code>：获取用户列表，应该返回一个数组。</li>
<li><code>GET /user/:id</code>：获取指定的用户，应该返回一个对象。</li>
<li><code>POST /user</code>：创建一个用户，应该返回被存储的对象，状态码应该为 201(Created)。</li>
<li><code>PUT /user</code>：修改一个用户的信息，应该返回修改后的对象。</li>
<li><code>DELETE /user/:id</code>：删除一个用户，状态码应该为 204(No Content)。</li>
</ul>
<p>如果 user 表有一个关系表 feed，那么我们的路径就会再复杂一点：</p>
<ul>
<li><code>GET /user/:id/feed</code> 或 <code>GET /feed?user_id=:id</code>：获取某个用户的帖子，应该返回一个数组。</li>
<li><code>GET /user/:id/feed/:feed_id</code> 或 <code>GET /feed/:id</code>：获取指定的帖子，应该返回一个对象。</li>
</ul>
<p>上述的例子中还会衍生出其他的数据操作，不仅仅只有 <code>GET</code>，这里不一一列举了。</p>
<h4 id="抽象出规则"><a href="#抽象出规则" class="headerlink" title="抽象出规则"></a>抽象出规则</h4><p>上一节中，列举了要提供一个表的数据访问 API，大概要实现哪些路由。从这些枚举中，可以找出其中的规律，总结出一套规则。最终我们在「<strong>把能实现的路由，全部实现</strong>」的原则基础上，开发了 RestQL 的 koa 版本。</p>
<p>支持的 HTTP 方法：</p>
<table>
<thead>
<tr>
<th>HTTP verb</th>
<th>CRUD</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>Read</td>
</tr>
<tr>
<td>POST</td>
<td>Create</td>
</tr>
<tr>
<td>PUT</td>
<td>Create/Update</td>
</tr>
<tr>
<td>DELETE</td>
<td>Delete</td>
</tr>
</tbody>
</table>
<p>支持的带有 body 的 HTTP 方法：</p>
<table>
<thead>
<tr>
<th>HTTP verb</th>
<th>List</th>
<th>Single</th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td>Array/Object</td>
<td>×</td>
</tr>
<tr>
<td>PUT</td>
<td>Array/Object</td>
<td>Object</td>
</tr>
</tbody>
</table>
<p><strong>说明</strong>：</p>
<ul>
<li><code>List</code> 路径为返回值为数组的路径，包括：<ul>
<li><code>/resource</code></li>
<li><code>/resource/:id/association</code>, association 为 <code>1:n</code> 关系</li>
<li><code>/resource/:id/association</code>, association 为 <code>n:m</code> 关系</li>
</ul>
</li>
<li><code>Single</code> 路径为返回值为单个对象的路径，包括：<ul>
<li><code>/resource/:id</code></li>
<li><code>/resource/:id/association</code>, association 为 <code>1:1</code> 关系</li>
<li><code>/resource/:id/association/:id</code>, association 为 <code>1:n</code> 关系</li>
<li><code>/resource/:id/association/:id</code>, association 为 <code>n:m</code> 关系</li>
</ul>
</li>
</ul>
<h3 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h3><p>我们已经开源了 koa-restql，koa 应用开发者可以通过 npm 安装它：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install koa-restql</div></pre></td></tr></table></figure>
<p>然后在 koa 应用的代码中引用 RestQL：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> koa       = <span class="built_in">require</span>(<span class="string">'koa'</span>)</div><div class="line"><span class="keyword">const</span> RestQL    = <span class="built_in">require</span>(<span class="string">'koa-restql'</span>)</div><div class="line"></div><div class="line"><span class="keyword">let</span> app = koa()</div><div class="line"><span class="comment">// Build APIs from `sequelize.models`</span></div><div class="line"><span class="keyword">let</span> restql = <span class="keyword">new</span> RestQL(sequelize.models)</div><div class="line">app.use(restql.routes())</div></pre></td></tr></table></figure>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="修改参数"><a href="#修改参数" class="headerlink" title="修改参数"></a>修改参数</h3><p>用户可以通过<code>querystring</code>来修改参数。强烈建议使用<code>qs</code>对 querystring 进行解析，例如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">qs.stringify(&#123;<span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>:<span class="number">2</span>&#125;) <span class="comment">// =&gt; a=1&amp;b=2</span></div></pre></td></tr></table></figure>
<p>RestQL 中的<code>querystring</code>仅有 3 条规则：</p>
<ul>
<li><p>所有不以<code>_</code>开头的建，都会被放进<code>sequelize#query()</code>的<code>where</code>参数中。例如：</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// query</span></div><div class="line">&#123;</div><div class="line">  <span class="attr">name</span>: <span class="string">"Li Xin"</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// option for sequelize</span></div><div class="line">&#123;</div><div class="line">  <span class="attr">where</span>: &#123;</div><div class="line">    <span class="attr">name</span>: <span class="string">"Li Xin"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>所有以<code>_</code>开头的建，都会被放进<code>sequelize#query()</code>的参数中，和<code>where</code>保持平级。例如：</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// query</span></div><div class="line">&#123;</div><div class="line">  <span class="attr">_limit</span>: <span class="number">10</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// option for sequelize</span></div><div class="line">&#123;</div><div class="line">  <span class="attr">limit</span>: <span class="number">10</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>当需要使用关系时，可以用关系名称的字符串代替关系对象传入。例如需要使用<code>include</code>时：</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// query</span></div><div class="line">&#123;</div><div class="line">  <span class="attr">_include</span>: [<span class="string">'friends'</span>]</div><div class="line">&#125;</div><div class="line"><span class="comment">// option for sequelize</span></div><div class="line">&#123;</div><div class="line">  <span class="attr">include</span>: [</div><div class="line">    models.user.association.friends</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="访问控制"><a href="#访问控制" class="headerlink" title="访问控制"></a>访问控制</h3><p>通常来说，我们有两种方法实现访问控制：</p>
<h4 id="通过中间件"><a href="#通过中间件" class="headerlink" title="通过中间件"></a>通过中间件</h4><p>在 koa 应用挂载 RestQL 的 router 之前，可以实现一个鉴权中间件，控制用户的访问权限：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">app.use(authorizeMiddleware)</div><div class="line">app.use(restql.routes())</div></pre></td></tr></table></figure>
<p><img src="/img/koa-restql-authorize-middleware.jpeg" alt="Authorize Middleware"></p>
<h4 id="通过-restql-参数"><a href="#通过-restql-参数" class="headerlink" title="通过 restql 参数"></a>通过 restql 参数</h4><p>在使用<code>sequelize</code>定义关联时，我们可以设定<code>restql</code>参数，实现访问控制。例如：</p>
<ul>
<li><p>禁止通过<code>restql</code>访问关联：</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">models.user.hasOne(</div><div class="line">  models.privacy,</div><div class="line">  &#123;</div><div class="line">    <span class="attr">restql</span>: &#123;</div><div class="line">      <span class="attr">ignore</span>: <span class="literal">true</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">)</div></pre></td></tr></table></figure>
</li>
<li><p>禁止通过<code>restql</code>使用指定的 HTTP 方法访问关联</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">models.user.hasOne(</div><div class="line">  models.privacy,</div><div class="line">  &#123;</div><div class="line">    <span class="attr">restql</span>: &#123;</div><div class="line">      <span class="attr">ignore</span>: [<span class="string">'get'</span>]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">)</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="其他语言-框架"><a href="#其他语言-框架" class="headerlink" title="其他语言/框架"></a>其他语言/框架</h4><p>目前我们仅实现了基于<code>node</code>和<code>koa</code>的版本，还没有其他语言/框架的实现版本。欢迎开发者提交其他语言/框架的实现到 <a href="https://github.com/RestQL" target="_blank" rel="external">RestQL 组</a>。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li>GitHub, <a href="https://github.com/koajs/koa" target="_blank" rel="external">koajs/koa</a></li>
<li>GitHub, <a href="https://github.com/sequelize/sequelize" target="_blank" rel="external">sequelize/sequelize</a></li>
<li>GitHub, <a href="https://github.com/Meituan-Dianping/koa-restql" target="_blank" rel="external">meituan-dianping/koa-restql</a></li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RESTful/">RESTful</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/koa/">koa</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nodejs/">nodejs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sequelize/">sequelize</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/企业平台/">企业平台</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/前端/">前端</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: false,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
    


  
    <article id="post-relational-database-vs-document-oriented-database-in-data-structure" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/08/relational-database-vs-document-oriented-database-in-data-structure/" class="article-date">
  	<time datetime="2016-08-08T09:49:00.000Z" itemprop="datePublished">2016-08-08</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/08/relational-database-vs-document-oriented-database-in-data-structure/">从数据结构出发对比关系型数据库和文档型数据库</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>现在文档性数据库火的不行，动不动就听到谁家用了 MongoDB。但是当问及他们为什么选择 MongoDB 时，多数人都是一脸懵逼的表情。甚至有人给出下面一些荒唐的理由：</p>
<ul>
<li><strong>文档型数据库特别火，所以我们用它。</strong><br>  这就不用解释了。</li>
<li><strong>文档性数据库不需要定义表结构，开发方便。</strong><br>  在一些高度工程化的项目中，即使采用文档性数据库，也是要定义文档结构的。另外，关系型数据库也有可以自动修改表结构的。</li>
<li><strong>文档性数据库就是 JSON，对写 JS 的同学更友好。</strong><br>  「文档」不一定就是 JSON。常见的文档结构还有 XML、protobuf 等。所以文档型数据库不见得一定会对前端同学更友好。另外，一些关系型数据库也提供 JSON 格式的输出。</li>
</ul>
<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><h3 id="关系型"><a href="#关系型" class="headerlink" title="关系型"></a>关系型</h3><p>关系型数据库最典型的数据结构是<strong>表</strong>。通常长下面这个样子：</p>
<p>Table A</p>
<table>
<thead>
<tr>
<th>id</th>
<th>content</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>test a</td>
</tr>
<tr>
<td>2</td>
<td>test b</td>
</tr>
</tbody>
</table>
<p>Table B:</p>
<table>
<thead>
<tr>
<th>id</th>
<th>table_a_id</th>
<th>content</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>test c</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>test d</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
<td>test e</td>
</tr>
<tr>
<td>4</td>
<td>2</td>
<td>test f</td>
</tr>
</tbody>
</table>
<h3 id="文档型"><a href="#文档型" class="headerlink" title="文档型"></a>文档型</h3><p>文档性数据库最典型的数据结构，当然是<strong>文档</strong>。以 JSON 为例，通常长下面这个样子：</p>
<p>Collection A:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">    &#123;</div><div class="line">        <span class="string">"id"</span>: <span class="number">1</span>,</div><div class="line">        <span class="string">"content"</span>: <span class="string">"test a"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="string">"id"</span>: <span class="number">2</span>,</div><div class="line">        <span class="string">"content"</span>: <span class="string">"test b"</span></div><div class="line">    &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<p>Collection B:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">    &#123;</div><div class="line">        <span class="string">"id"</span>: <span class="number">1</span>,</div><div class="line">        <span class="string">"collection_a_id"</span>: <span class="number">1</span>,</div><div class="line">        <span class="string">"content"</span>: <span class="string">"test c"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="string">"id"</span>: <span class="number">2</span>,</div><div class="line">        <span class="string">"collection_a_id"</span>: <span class="number">1</span>,</div><div class="line">        <span class="string">"content"</span>: <span class="string">"test d"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="string">"id"</span>: <span class="number">3</span>,</div><div class="line">        <span class="string">"collection_a_id"</span>: <span class="number">2</span>,</div><div class="line">        <span class="string">"content"</span>: <span class="string">"test e"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="string">"id"</span>: <span class="number">4</span>,</div><div class="line">        <span class="string">"collection_a_id"</span>: <span class="number">2</span>,</div><div class="line">        <span class="string">"content"</span>: <span class="string">"test f"</span></div><div class="line">    &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><h3 id="文档性"><a href="#文档性" class="headerlink" title="文档性"></a>文档性</h3><h4 id="经常进行连接查询"><a href="#经常进行连接查询" class="headerlink" title="经常进行连接查询"></a>经常进行连接查询</h4><p>我们要对上面的 A 和 B 进行连接查询，关系型数据库返回的是两个表的笛卡尔积：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>content</th>
<th>table_b.id</th>
<th>table_b.table_a_id</th>
<th>table_b.content</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>test a</td>
<td>1</td>
<td>1</td>
<td>test c</td>
</tr>
<tr>
<td>1</td>
<td>test a</td>
<td>2</td>
<td>1</td>
<td>test d</td>
</tr>
<tr>
<td>2</td>
<td>test b</td>
<td>3</td>
<td>2</td>
<td>test e</td>
</tr>
<tr>
<td>2</td>
<td>test b</td>
<td>4</td>
<td>2</td>
<td>test f</td>
</tr>
</tbody>
</table>
<p>上表中的第 2 行和第4 行都是冗余的。这种现象在复杂的连接查询中会被放大的很可怕。我们有的业务在一次查询中连接了 12 张表，冗余的数据可不止一个<code>A.content</code>字段这么简单。</p>
<p>这种情况下再来看看文档性数据库的返回结果，就非常合理了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">    &#123;</div><div class="line">        <span class="string">"left"</span>: &#123;</div><div class="line">            <span class="string">"id"</span>: <span class="number">1</span>,</div><div class="line">            <span class="string">"content"</span>: <span class="string">"test a"</span></div><div class="line">        &#125;,</div><div class="line">        <span class="string">"right"</span>: [</div><div class="line">            &#123;</div><div class="line">                <span class="string">"id"</span>: <span class="number">1</span>,</div><div class="line">                <span class="string">"collection_a_id"</span>: <span class="number">1</span>,</div><div class="line">                <span class="string">"content"</span>: <span class="string">"test c"</span></div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                <span class="string">"id"</span>: <span class="number">2</span>,</div><div class="line">                <span class="string">"collection_a_id"</span>: <span class="number">1</span>,</div><div class="line">                <span class="string">"content"</span>: <span class="string">"test d"</span></div><div class="line">            &#125;</div><div class="line">        ]</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="string">"left"</span>: &#123;</div><div class="line">            <span class="string">"id"</span>: <span class="number">2</span>,</div><div class="line">            <span class="string">"content"</span>: <span class="string">"test b"</span></div><div class="line">        &#125;,</div><div class="line">        <span class="string">"right"</span>: [</div><div class="line">            &#123;</div><div class="line">                <span class="string">"id"</span>: <span class="number">3</span>,</div><div class="line">                <span class="string">"collection_a_id"</span>: <span class="number">2</span>,</div><div class="line">                <span class="string">"content"</span>: <span class="string">"test e"</span></div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                <span class="string">"id"</span>: <span class="number">4</span>,</div><div class="line">                <span class="string">"collection_a_id"</span>: <span class="number">2</span>,</div><div class="line">                <span class="string">"content"</span>: <span class="string">"test f"</span></div><div class="line">            &#125;</div><div class="line">        ]</div><div class="line">    &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<p>也有冗余，但是冗余的是字段的 key，完全是可控的。假如使用 protobuf 提前定义好结构，这种冗余甚至会被消除。</p>
<h4 id="同一个表不同记录的数据结构经常不一样"><a href="#同一个表不同记录的数据结构经常不一样" class="headerlink" title="同一个表不同记录的数据结构经常不一样"></a>同一个表不同记录的数据结构经常不一样</h4><p>假如你的表中存在很多互斥的字段，文档型数据库可能更适合你的系统。例如你又这样一张表：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>x</th>
<th>y</th>
<th>z</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>null</td>
<td>null</td>
</tr>
<tr>
<td>2</td>
<td>null</td>
<td>2</td>
<td>null</td>
</tr>
<tr>
<td>3</td>
<td>null</td>
<td>null</td>
<td>3</td>
</tr>
<tr>
<td>4</td>
<td>null</td>
<td>null</td>
<td>null</td>
</tr>
</tbody>
</table>
<p>商标中<code>x</code>、<code>y</code>、<code>z</code>字段在每条记录张最多出现一次，然而<code>null</code>依然需要在存储或传输的时候占位。</p>
<p>这种时候，相比之下采用文档性数据库会更合理：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">    &#123;</div><div class="line">        <span class="string">"id"</span>: <span class="number">1</span>,</div><div class="line">        <span class="string">"x"</span>: <span class="number">1</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="string">"id"</span>: <span class="number">2</span>,</div><div class="line">        <span class="string">"x"</span>: <span class="number">1</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="string">"id"</span>: <span class="number">3</span>,</div><div class="line">        <span class="string">"x"</span>: <span class="number">1</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="string">"id"</span>: <span class="number">4</span></div><div class="line">    &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<h3 id="关系型-1"><a href="#关系型-1" class="headerlink" title="关系型"></a>关系型</h3><p>除上述几种情况外，关系型数据库往往会更适合你的系统。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: false,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
    


  
    <article id="post-use-jiathis-on-https-site" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/02/use-jiathis-on-https-site/" class="article-date">
  	<time datetime="2016-08-02T10:40:05.000Z" itemprop="datePublished">2016-08-02</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/02/use-jiathis-on-https-site/">在 HTTPS 站点使用 jiathis</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <blockquote>
<p>我的反向代理服务器 IP 被屏蔽了，大家都洗洗睡吧，太恶心了，不提供 HTTPS 也不让别人提供。<br>我已经换成了多说的分享插件。</p>
</blockquote>
<hr>
<p>三步搞定：</p>
<ol>
<li>需要一个 https 的反向代理，懒得建的话，可以直接用我的：<br> <a href="//v3-jiathis-com-proxy.crzidea.com/code/jia.js">//v3-jiathis-com-proxy.crzidea.com/code/jia.js</a>。</li>
<li><p>在全局配置变量中，设置<code>do_not_track: true</code>。可以干掉发往 id.jiathis.com 域的请求。</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> jiathis_config=&#123;</div><div class="line">    <span class="attr">summary</span>:<span class="string">""</span>,</div><div class="line">    <span class="attr">shortUrl</span>:<span class="literal">false</span>,</div><div class="line">    <span class="attr">hideMore</span>:<span class="literal">false</span>,</div><div class="line">    <span class="attr">do_not_track</span>: <span class="literal">true</span> <span class="comment">// 干掉发往 id.jiathis.com 域的请求</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>禁用分享计数器，把类名包含<code>jiathis_counter_style</code>的 HTML 元素删掉即可。可以干掉发往 i.jiathis.com 域的请求。</p>
</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/https/">https</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/share/">share</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: false,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
    


  
    <article id="post-Understanding-user-group-on-Linux" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/07/25/Understanding-user-group-on-Linux/" class="article-date">
  	<time datetime="2016-07-25T05:35:13.000Z" itemprop="datePublished">2016-07-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/25/Understanding-user-group-on-Linux/">理解 Linux 中的用户组</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p><strong>注意</strong>：为了避免实际操作过程中 SELinux 可能会造成的影响，建议先关闭 SELinux：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">setenforce Permissive</div></pre></td></tr></table></figure>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h3><p>创建用户：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">useradd LOGIN</div></pre></td></tr></table></figure>
<h3 id="组"><a href="#组" class="headerlink" title="组"></a>组</h3><ul>
<li><p>查看用户所属的组：</p>
  <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">groups LOGIN</div></pre></td></tr></table></figure>
</li>
<li><p>为用户设置默认组：</p>
  <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">usermod -g GROUP1 LOGIN</div></pre></td></tr></table></figure>
<p>  <strong>注意</strong>：执行该命令会讲指定用户<code>$HOME</code>目录中的文件权限重新设置。</p>
</li>
<li><p>将用户添加到组：</p>
  <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">usermod -aG GROUP2 LOGIN</div></pre></td></tr></table></figure>
<p>  <strong>注意</strong>：将用户添加到组并不会更改用户的默认组。例如用户 A 同时属于 GROUP1、GROUP2，但是 primary group 是 GROUP1，另一个用户 B 使用 GROUP2 创建了一个文件并设置了访问权限为<code>rw-rw----</code>，默认情况下，用户 A 是无法访问这个文件的。</p>
</li>
<li><p>使用指定的组进行操作：</p>
  <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sg GROUP2 [COMMAND]</div></pre></td></tr></table></figure>
<p>  <strong>小贴士</strong>：不加<code>COMMAND</code>参数会默认运行一个 bash 进程。</p>
</li>
</ul>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><h3 id="讲用户添加到一个有-sudo-权限的组中"><a href="#讲用户添加到一个有-sudo-权限的组中" class="headerlink" title="讲用户添加到一个有 sudo 权限的组中"></a>讲用户添加到一个有 sudo 权限的组中</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 一般系统中都会有一个名为 wheel 的组</span></div><div class="line">sudo usermod -g wheel <span class="variable">$USER</span></div><div class="line"><span class="comment"># 假如你不想在每次使用 sudo 时输入密码，就在下面的文件中添加一行</span></div><div class="line"><span class="comment"># %wheel  ALL=(ALL)   NOPASSWD: ALL</span></div><div class="line">sudo visudo</div></pre></td></tr></table></figure>
<h3 id="不使用-sudo-访问-docker"><a href="#不使用-sudo-访问-docker" class="headerlink" title="不使用 sudo 访问 docker"></a>不使用 sudo 访问 docker</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sudo usermod -aG docker <span class="variable">$USER</span></div><div class="line">sg docker <span class="string">'docker ps'</span></div><div class="line"><span class="comment"># 假如你觉得上面这个命令太长，可以不输入`COMMAND`参数</span></div><div class="line">sg docker</div><div class="line"><span class="comment"># 现在打开了一个新的 bash 进程，你的所有操作默认会使用`docker`组的权限进行</span></div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/user-group/">user group</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: false,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
    


  
    <article id="post-react-must-die" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/07/22/react-must-die/" class="article-date">
  	<time datetime="2016-07-22T10:26:24.000Z" itemprop="datePublished">2016-07-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/22/react-must-die/">为什么我要唱衰 React</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>其实对于 React 的态度，我一直是比较明确的。但是最近有不少人跟我聊这个事情，我想还是有些点需要总结的。</p>
<h2 id="我们为什么需要-React？"><a href="#我们为什么需要-React？" class="headerlink" title="我们为什么需要 React？"></a>我们为什么需要 React？</h2><p>这是一个来自<a href="https://www.zhihu.com/question/47161776" target="_blank" rel="external">知乎</a>的问题。</p>
<p>实际上，大部分人在用 React 的时候，用到的是两个特性：</p>
<ol>
<li>虚拟 DOM</li>
<li>组件化</li>
</ol>
<p>至于其他的伪特性，我认为是有些同学「一瓶子不满，半瓶子咣当」，意淫出来的。这些伪特性包括：</p>
<ol>
<li><strong>跨平台</strong>。虽然 ReactNative 可以在多个平台上使用，但是 ReactNative 并没有封装不同系统的 API。从这方面来说，这货甚至连 weex 都不如。</li>
<li><strong>更易于组织逻辑</strong>。这明显是 flux/redux 做的事情。而且 redux 已经明确说明了，不仅仅适用于 React，其他框架也可以用 redux。</li>
</ol>
<h2 id="我们真的需要上述的两个特性吗？"><a href="#我们真的需要上述的两个特性吗？" class="headerlink" title="我们真的需要上述的两个特性吗？"></a>我们真的需要上述的两个特性吗？</h2><h3 id="虚拟-DOM"><a href="#虚拟-DOM" class="headerlink" title="虚拟 DOM"></a>虚拟 DOM</h3><p>虚拟 DOM 解决了频繁操作 DOM<br>产生的性能问题。那么下面几项事实必定会导致这一特性「没有前途」：</p>
<ol>
<li>设备的硬件性能会越来越好，性能在将来不再是问题。</li>
<li>假如说我们要解决性能问题，相比虚拟 DOM，下面几个解决方案会更好：<ol>
<li>浏览器实现虚拟 DOM。而且这也是虚拟 DOM 被应用的正确场景和姿势。</li>
<li>再操作数据的地方做 diff，而不是在虚拟 DOM 的基础上做 diff。这是才是<br>cache/diff 的正确用法。</li>
</ol>
</li>
</ol>
<p>所以我认为虚拟 DOM 必定是「没有前途」的。</p>
<h3 id="组件化"><a href="#组件化" class="headerlink" title="组件化"></a>组件化</h3><p>组件化有一个很重要的目的是为了提高开发效率。再来看一下使用 React 开发效率高吗？</p>
<blockquote>
<p>民间：想加班就用 React</p>
</blockquote>
<p>为了说明 React 的开发效率，不妨点开两个链接看一下代码行数。下面两个链接都实现了一个聊天应用，完全一样的功能：</p>
<ul>
<li><a href="https://github.com/rethinkdb/horizon/blob/next/examples/react-chat-app/dist/app.jsx" target="_blank" rel="external">React 版本：187 行</a></li>
<li><a href="https://github.com/rethinkdb/horizon/blob/next/examples/riotjs-chat-app/dist/chat.tag" target="_blank" rel="external">Riot 版本：53 行</a></li>
</ul>
<p>你还需要啥理由丢弃 React？</p>
<h2 id="感谢-React"><a href="#感谢-React" class="headerlink" title="感谢 React"></a>感谢 React</h2><p>虽然我并不认同 React 的一些解决问题的方法，甚至觉得它「没有前途」，但是 React 对行业做出的贡献是众所周知的。最后还是感谢 facebook 工程师的贡献。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/">React</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: false,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
    


  
    <article id="post-Test-scaling-sharding-and-replication-feature-of-rethinkdb-with-docker" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/07/19/Test-scaling-sharding-and-replication-feature-of-rethinkdb-with-docker/" class="article-date">
  	<time datetime="2016-07-19T09:40:41.000Z" itemprop="datePublished">2016-07-19</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/19/Test-scaling-sharding-and-replication-feature-of-rethinkdb-with-docker/">使用 docker 测试 rethinkdb 的高可用和可扩展特性</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>rethinkdb 在高可用和扩展性方面做得出奇的好，而且非常好理解。这篇博客讲的只是如何使用 docker 对 rethinkdb 的这些特性做一些简单测试。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>首先确保有一台可以运行 docker 的机器。然后使用 docker 创建一个 rethinkdb 容器。</p>
<ol>
<li><p>获取 rethinkdb 镜像：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker pull rethinkdb</div></pre></td></tr></table></figure>
</li>
<li><p>创建 rethinkdb 容器（为了便于理解，所有命令行参数均使用全写）：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run --publish-all --detach rethinkdb</div></pre></td></tr></table></figure>
</li>
<li><p>找出容器内 8080 端口映射到外部的端口（下面的例子中，被映射到外部的端口是 32780）：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker ps</div></pre></td></tr></table></figure>
<p> 应该会得到类似下面的输出（此处已经把所有干扰列删除了）：</p>
 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">CONTAINER ID    IMAGE        PORTS</div><div class="line">bce34ef8fc56    rethinkdb    <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">32780</span>-&gt;<span class="number">8080</span>/tcp, <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">32779</span>-&gt;<span class="number">28015</span>/tcp, <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">32778</span>-&gt;<span class="number">29015</span>/tcp</div></pre></td></tr></table></figure>
</li>
<li><p>在你的本地浏览器中访问 rethinkdb 的 WebUI（此处的例子中，WebUI 的地址为 <a href="http://server:32780" target="_blank" rel="external">http://server:32780</a> ）。</p>
</li>
</ol>
<h2 id="扩展性"><a href="#扩展性" class="headerlink" title="扩展性"></a>扩展性</h2><p>准确的说，我们会测试它的伸缩能力，即「增加节点」和「摘除节点」。</p>
<p>为了完整演示整个测试过程，需要再创建一个可以交互的容器，并把将创建的两个容器设置到同一个虚拟网络中：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run --publish-all --link bce34ef8fc56 --interactive --tty rethinkdb bash</div></pre></td></tr></table></figure>
<h3 id="增加节点"><a href="#增加节点" class="headerlink" title="增加节点"></a>增加节点</h3><p>成功创建容器之后，我们会获得了一个来自容器的可以交互的终端。要增加节点，只需要在新容器内运行下面的命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rethinkdb --join bce34ef8fc56</div></pre></td></tr></table></figure>
<p>再次感叹一下，扩展一个数据库服务的命令行就应该是这个样子，感谢 rethinkdb，把被各种小聪明玷污的工具逻辑还原出来了本来的面容。</p>
<h3 id="平衡节点上的表"><a href="#平衡节点上的表" class="headerlink" title="平衡节点上的表"></a>平衡节点上的表</h3><p>终于轮到 rethinkdb 的 WebUI 登场了。</p>
<ol>
<li>访问上文中创建好的 WebUI 服务（<a href="http://server:32780）" target="_blank" rel="external">http://server:32780）</a></li>
<li><p>打开「Data Explorer」标签页，分别给两个节点设置标签：</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> config = r.db(<span class="string">'rethinkdb'</span>).table(<span class="string">'server_config'</span>);</div><div class="line">config.filter(&#123;<span class="attr">name</span>: <span class="string">'bce34ef8fc56_iz6'</span>&#125;).update(&#123;<span class="attr">tags</span>: [<span class="string">'default'</span>, <span class="string">'node_a'</span>]&#125;);</div><div class="line">config.filter(&#123;<span class="attr">name</span>: <span class="string">'d72b193f46d5_jp6'</span>&#125;).update(&#123;<span class="attr">tags</span>: [<span class="string">'default'</span>, <span class="string">'node_b'</span>]&#125;);</div></pre></td></tr></table></figure>
<p> <strong>提示</strong>：要查询<code>server_config</code>表中的内容，可以使用<code>config.filter({})</code>。<br> <strong>注意</strong>：必须至少有一个<code>tags</code>包含<code>default</code>的节点，新创建的表会被分配到有<code>default</code>标签的节点上。</p>
</li>
<li><p>创建两个表：</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> test = r.db(<span class="string">'test'</span>);</div><div class="line">test.tableCreate(<span class="string">'table_a'</span>);</div><div class="line">test.tableCreate(<span class="string">'table_b'</span>);</div></pre></td></tr></table></figure>
</li>
<li><p>查询表在各节点的分布情况：</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">r.db(<span class="string">'rethinkdb'</span>).table(<span class="string">'table_status'</span>)</div></pre></td></tr></table></figure>
<p> 输出结果（已去除干扰信息）：</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[&#123;</div><div class="line">  <span class="string">"name"</span>: <span class="string">"table_b"</span>,</div><div class="line">  <span class="string">"shards"</span>: [&#123;</div><div class="line">    <span class="string">"primary_replicas"</span>: [<span class="string">"bce34ef8fc56_iz6"</span>]</div><div class="line">  &#125;]</div><div class="line">&#125;, &#123;</div><div class="line">  <span class="string">"name"</span>: <span class="string">"table_a"</span>,</div><div class="line">  <span class="string">"shards"</span>: [&#123;</div><div class="line">    <span class="string">"primary_replicas"</span>: [<span class="string">"d72b193f46d5_jp6"</span>]</div><div class="line">  &#125;]</div><div class="line">&#125;]</div></pre></td></tr></table></figure>
<p> 可以看到新创建的表已经被自动分布到了两个节点上。</p>
</li>
<li><p>测试分布在不同节点上的表的连接查询</p>
<ol>
<li><p>往<code>table_a</code>插入测试数据：</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">r.db(<span class="string">'test'</span>).table(<span class="string">'table_a'</span>).insert(&#123;<span class="attr">key_a</span>: <span class="number">1</span>&#125;);</div></pre></td></tr></table></figure>
<p> 假设返回的新创建的记录<code>id</code>为<code>7415e20c-6fab-4813-85f0-f169c70699c9</code></p>
</li>
<li><p>往<code>table_b</code>插入测试数据：</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">r.db(<span class="string">'test'</span>).table(<span class="string">'table_b'</span>).insert(&#123;</div><div class="line">  <span class="attr">key_b</span>: <span class="number">2</span>,</div><div class="line">  <span class="attr">table_a_id</span>: <span class="string">'7415e20c-6fab-4813-85f0-f169c70699c9'</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
<li><p>测试连接查询：</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">r.db(<span class="string">'test'</span>).table(<span class="string">'table_b'</span>)</div><div class="line">.eqJoin(</div><div class="line">  <span class="string">'table_a_id'</span>,</div><div class="line">  r.db(<span class="string">'test'</span>).table(<span class="string">'table_a'</span>)</div><div class="line">)</div></pre></td></tr></table></figure>
<p> 输出结果：</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[&#123;</div><div class="line">  <span class="string">"left"</span>: &#123;</div><div class="line">    <span class="string">"id"</span>: <span class="string">"2b9bebc7-bb98-45b8-9304-8a19479f4bcb"</span>,</div><div class="line">    <span class="string">"key_b"</span>: <span class="number">2</span>,</div><div class="line">    <span class="string">"table_a_id"</span>: <span class="string">"7415e20c-6fab-4813-85f0-f169c70699c9"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"right"</span>: &#123;</div><div class="line">    <span class="string">"id"</span>: <span class="string">"7415e20c-6fab-4813-85f0-f169c70699c9"</span>,</div><div class="line">    <span class="string">"key_a"</span>: <span class="number">1</span></div><div class="line">  &#125;</div><div class="line">&#125;]</div></pre></td></tr></table></figure>
<p> 由此可以得出结论，即使被查询的表分布在不同节点上，仍然可以使用连接查询。</p>
</li>
</ol>
</li>
</ol>
<h3 id="强制摘除节点"><a href="#强制摘除节点" class="headerlink" title="强制摘除节点"></a>强制摘除节点</h3><p>要模拟「强制摘除节点」，只需要在容器的终端上按下<code>Ctrl + C</code>。</p>
<p>摘除节点之后，WebUI 会提示下面的内容：</p>
<blockquote>
<p>Table test.table_a is not available.</p>
<p>None of the replicas for this table are reachable (the servers for these<br>replicas may be down or disconnected).<br>No operations can be performed on this table until at least one replica is<br>reachable.</p>
</blockquote>
<p>当然，这个时候执行上面的连接查询，也是会出错的：</p>
<blockquote>
<p>e: Cannot perform read: primary replica for shard [“”, +inf) not available in:<br>r.db(“test”).table(“table_b”).eqJoin(“table_a_id”, r.db(“test”).table(“table_a”))</p>
</blockquote>
<p>所以我们还是先恢复这个节点吧：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rethinkdb --join bce34ef8fc56</div></pre></td></tr></table></figure>
<h2 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h2><h3 id="安全摘除节点"><a href="#安全摘除节点" class="headerlink" title="安全摘除节点"></a>安全摘除节点</h3><ol>
<li><p>将所有的表都调度到 node_a 上：</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">r.db(<span class="string">'test'</span>).table(<span class="string">'table_a'</span>).reconfigure(&#123;<span class="attr">shards</span>: <span class="number">1</span>, <span class="attr">replicas</span>: &#123;<span class="attr">node_a</span>: <span class="number">1</span>&#125;, <span class="attr">primary_replica_tag</span>: <span class="string">'node_a'</span>&#125;);</div><div class="line">r.db(<span class="string">'test'</span>).table(<span class="string">'table_b'</span>).reconfigure(&#123;<span class="attr">shards</span>: <span class="number">1</span>, <span class="attr">replicas</span>: &#123;<span class="attr">node_a</span>: <span class="number">1</span>&#125;, <span class="attr">primary_replica_tag</span>: <span class="string">'node_a'</span>&#125;);</div></pre></td></tr></table></figure>
<p> <strong>注意</strong>：切换主节点会造成指定的表短暂的无法访问。</p>
</li>
<li>在容器的终端上再次按下<code>Ctrl + C</code></li>
<li>测试连接查询，现在不会出错了</li>
</ol>
<h3 id="替换主节点"><a href="#替换主节点" class="headerlink" title="替换主节点"></a>替换主节点</h3><ol>
<li><p>为了能在外部访问到用于替换主节点的节点上的服务，需要在启动服务的命令行上加一个参数：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rethinkdb --join bce34ef8fc56 --<span class="built_in">bind</span>-all</div></pre></td></tr></table></figure>
</li>
<li><p>然后使用在容器的宿主机上执行<code>docker ps</code>来查找容器内 8080<br>端口被映射到外部的端口。这里假设是 32786。</p>
</li>
<li><p>访问 <a href="http://server:32786/#dataexplorer" target="_blank" rel="external">http://server:32786/#dataexplorer</a> ，将所有的表调度到 node_b 上：</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">r.db(<span class="string">'test'</span>).table(<span class="string">'table_a'</span>).reconfigure(&#123;<span class="attr">shards</span>: <span class="number">1</span>, <span class="attr">replicas</span>: &#123;<span class="attr">node_b</span>: <span class="number">1</span>&#125;, <span class="attr">primary_replica_tag</span>: <span class="string">'node_b'</span>&#125;);</div><div class="line">r.db(<span class="string">'test'</span>).table(<span class="string">'table_b'</span>).reconfigure(&#123;<span class="attr">shards</span>: <span class="number">1</span>, <span class="attr">replicas</span>: &#123;<span class="attr">node_b</span>: <span class="number">1</span>&#125;, <span class="attr">primary_replica_tag</span>: <span class="string">'node_b'</span>&#125;);</div></pre></td></tr></table></figure>
</li>
<li><p>在宿主机上停掉之前的主节点：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker stop bce34ef8fc56</div></pre></td></tr></table></figure>
</li>
<li><p>在新节点上执行查询，没有任何报警</p>
</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>整个测试过程搞完之后，对 rethinkdb 基本上可以有相当的信心了。没啥好说的，用 rethinkdb 完全不用担心分布式架构的问题了，所有的运维过程完全不需要 DBA 介入。</p>
<hr>
<p>参考：<a href="https://www.rethinkdb.com/docs/sharding-and-replication/" target="_blank" rel="external">Scaling, sharding and replication</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/replication/">replication</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rethinkdb/">rethinkdb</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/scaling/">scaling</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sharding/">sharding</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: false,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
    


  
    <article id="post-configure-docker-registry-mirror-with-systemd" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/07/19/configure-docker-registry-mirror-with-systemd/" class="article-date">
  	<time datetime="2016-07-19T09:05:55.000Z" itemprop="datePublished">2016-07-19</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/19/configure-docker-registry-mirror-with-systemd/">通过 systemd 设置 docker 仓库镜像</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>具体步骤（伸手党直接从第4步开始看）：</p>
<ol>
<li>找到一个可用的镜像服务，参考 <a href="http://rzhw.me/blog/2015/12/faster-docker-pulls-in-china-with-daocloud/" target="_blank" rel="external">Faster Docker pulls in China with DaoCloud</a>。</li>
<li><p>通过 yum 安装 docker 之后，检查 systemd service：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">systemctl status docker</div></pre></td></tr></table></figure>
<p> 从输出中找到对应的 .service 文件：</p>
 <figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">● docker.service - Docker Application Container Engine</div><div class="line"><span class="string">Loaded:</span> loaded (<span class="regexp">/usr/</span>lib<span class="regexp">/systemd/</span>system/docker.service; enabled; vendor <span class="string">preset:</span> disabled)</div><div class="line"><span class="string">Active:</span> active (running) since Tue <span class="number">2016</span><span class="number">-07</span><span class="number">-19</span> <span class="number">15</span>:<span class="number">02</span>:<span class="number">49</span> CST; <span class="number">2</span>h <span class="number">9</span>min ago</div><div class="line"><span class="symbol">  Docs:</span> <span class="string">http:</span><span class="comment">//docs.docker.com</span></div><div class="line">...</div></pre></td></tr></table></figure>
</li>
<li><p>在<code>docker.service</code>中找到相应的<code>OPTIONS</code>环境变量:</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /usr/lib/systemd/system/docker.service</div></pre></td></tr></table></figure>
<p> 找到下面几行（为了更易于理解，这里把所有的干扰项都删掉了）：</p>
 <figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">EnvironmentFile=-<span class="regexp">/etc/sysconfig</span><span class="regexp">/docker</span></div><div class="line">ExecStart=/bin<span class="regexp">/sh -c '/usr</span><span class="regexp">/bin/docker</span>-current daemon \</div><div class="line">          $OPTIONS \</div><div class="line">          <span class="number">2</span>&gt;&amp;<span class="number">1</span> | <span class="regexp">/usr/bin</span><span class="regexp">/forward-journald -tag docker'</span></div></pre></td></tr></table></figure>
</li>
<li><p>编辑<code>EnvironmentFile</code>项所指的文件，把参数加到<code>OPTIONS</code>环境变量里</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /etc/sysconfig/docker</div></pre></td></tr></table></figure>
<p> 编辑下面的内容：</p>
 <figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Modify these options if you want to change the way the docker daemon runs</span></div><div class="line"><span class="comment">#OPTIONS='--selinux-enabled --log-driver=journald'</span></div><div class="line">OPTIONS='<span class="params">--selinux-enabled</span> <span class="params">--log-driver=journald</span> <span class="params">--registry-mirror=http</span>:<span class="string">//YOUR_ID.m.daocloud.io</span>'</div></pre></td></tr></table></figure>
<p> <strong>注意</strong>：这个配置文件不支持使用 bash 的模板字符串。</p>
</li>
<li>重新启动 docker 服务： <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo systemctl restart docker</div></pre></td></tr></table></figure>
</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker-registry-mirror/">docker registry mirror</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/systemd/">systemd</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: false,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
    


  
    <article id="post-how-to-implenment-shuffle-method" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/17/how-to-implenment-shuffle-method/" class="article-date">
  	<time datetime="2016-05-17T08:36:26.000Z" itemprop="datePublished">2016-05-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/17/how-to-implenment-shuffle-method/">你的洗牌算法有可能是错的</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>本篇实际上是下面两篇博客的读后总结。如果读得懂，就不用往下看了：</p>
<ul>
<li><a href="https://www.h5jun.com/post/array-shuffle.html" target="_blank" rel="external">数组的完全随机排列</a></li>
<li><a href="http://coolshell.cn/articles/8593.html" target="_blank" rel="external">如何测试洗牌程序</a></li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="为什么使用下面的排序算法洗牌，结果是错的？"><a href="#为什么使用下面的排序算法洗牌，结果是错的？" class="headerlink" title="为什么使用下面的排序算法洗牌，结果是错的？"></a>为什么使用下面的排序算法洗牌，结果是错的？</h3><ul>
<li><strong>冒泡</strong> 先后边，后前边</li>
<li><strong>插入</strong> 县前边，后后边</li>
<li><strong>快排</strong> 先中间，后两边</li>
</ul>
<p>后生成的随机数和先生成的随机数比较时，满足交换条件的可能性越来越小。</p>
<p>造成了打乱的结果变得有规律：</p>
<ul>
<li>先被比较随机数的位置随机性比较大</li>
<li>后被比较随机数的位置保持原状的可能性比较大</li>
</ul>
<h3 id="怎么测试结果是随机的算法？"><a href="#怎么测试结果是随机的算法？" class="headerlink" title="怎么测试结果是随机的算法？"></a>怎么测试结果是随机的算法？</h3><ul>
<li>PC 机上是做不出真随机数的，只能做出伪随机数。真随机数需要硬件支持。</li>
<li>一到概率问题，我们只有一个方法来做测试，那就是用统计的方式。</li>
<li>测试的三个参数：样本数、最大误差、平均误差。</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/shuffle/">shuffle</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sort/">sort</a></li></ul>
	</div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>











    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: false,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
    


  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &gt;</a>
    </nav>
  

</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2017 crzidea.com
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的静态博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减双栏 Hexo 博客主题">Yelee</a> by MOxFIVE
        </div>
    </div>
    <div class="visit">
      <span id="busuanzi_container_site_pv" style='display:none'>
        <span id="site-visit" >本站到访数: 
        <span id="busuanzi_value_site_uv"></span>
        </span>
      </span>
      <span id="busuanzi_container_page_pv" style='display:none'>
        <span id="page-visit">, 本页阅读量: 
        <span id="busuanzi_value_page_pv"></span>
        </span>
      </span>
    </div>
  </div>
</footer>
    </div>
    
	<script>
		var yiliaConfig = {
			fancybox: false,
			mathjax: true,
			animate: false,
			isHome: true,
			isPost: false,
			isArchive: false,
			isTag: false,
			isCategory: false,
			open_in_new: false
		}
	</script>


<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

  <style>
    body {
      background: lightgray;
    }
    #container .left-col {
      background: white;
    }
    .article-inner {
      background: white;
    }
    .post-nav-button {
      background: #ececec;
    }
    #header .header-nav .social #GitHub {
      background-color: #bfd3ec;
    }
  </style>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-81807912-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
<a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
<a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>


<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  </div>

</body>
</html>
